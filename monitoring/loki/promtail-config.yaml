# Promtail Configuration for CAD ML Platform
# Collects logs and ships to Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: cad-ml-platform
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # Kubernetes pod logs
  - job_name: kubernetes-pods
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # Only scrape pods with specific annotation
      - source_labels: [__meta_kubernetes_pod_annotation_promtail_io_scrape]
        action: keep
        regex: true
      # Use pod name as job label
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      # Use namespace
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      # Use container name
      - source_labels: [__meta_kubernetes_pod_container_name]
        target_label: container
      # Add app label
      - source_labels: [__meta_kubernetes_pod_label_app]
        target_label: app
      # Add environment label
      - source_labels: [__meta_kubernetes_pod_label_environment]
        target_label: environment
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            level: level
            message: message
            timestamp: timestamp
            request_id: request_id
            trace_id: trace_id
            user_id: user_id
            service: service
      # Set timestamp from log
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      # Set log level
      - labels:
          level:
          request_id:
          trace_id:
      # Add structured labels
      - static_labels:
          cluster: production
      # Drop debug logs in production
      - match:
          selector: '{environment="production"} |= "DEBUG"'
          action: drop

  # CAD ML Platform specific scrape config
  - job_name: cad-ml-platform
    static_configs:
      - targets:
          - localhost
        labels:
          job: cad-ml-api
          __path__: /var/log/cad-ml/*.log
    pipeline_stages:
      # Parse JSON structured logs
      - json:
          expressions:
            level: level
            message: message
            timestamp: timestamp
            request_id: request_id
            trace_id: trace_id
            provider: provider
            latency_ms: latency_ms
            error_code: error_code
            endpoint: endpoint
            method: method
            status_code: status_code
            duration_ms: duration_ms
      # Extract timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      # Create labels from extracted values
      - labels:
          level:
          provider:
          endpoint:
          method:
          status_code:
          error_code:
      # Metrics from logs
      - metrics:
          http_request_duration:
            type: Histogram
            description: "HTTP request duration from logs"
            source: duration_ms
            config:
              buckets: [10, 50, 100, 250, 500, 1000, 2500, 5000]
          ocr_latency:
            type: Histogram
            description: "OCR processing latency"
            source: latency_ms
            config:
              buckets: [100, 500, 1000, 2000, 5000, 10000]

  # Docker container logs (for local development)
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
    pipeline_stages:
      - json:
          expressions:
            level: level
            message: message
