name: Metrics Budget Check

on:
  pull_request:
    paths:
      - 'src/**/*.py'
      - 'prometheus/**/*.yml'
      - 'grafana/**/*.json'
      - '**/metrics.py'

  workflow_dispatch:
    inputs:
      prometheus_url:
        description: 'Prometheus server URL'
        required: false
        default: 'http://prometheus:9090'
        type: string
      budget_threshold:
        description: 'Budget usage threshold (%)'
        required: false
        default: '90'
        type: number

env:
  PYTHON_VERSION: '3.9'
  PROMETHEUS_URL: ${{ github.event.inputs.prometheus_url || 'http://prometheus:9090' }}
  BUDGET_THRESHOLD: ${{ github.event.inputs.budget_threshold || 90 }}

jobs:
  analyze-metrics-changes:
    name: Analyze Metrics Changes
    runs-on: ubuntu-latest
    outputs:
      has_metrics_changes: ${{ steps.detect.outputs.has_changes }}
      metrics_added: ${{ steps.analyze.outputs.metrics_added }}
      labels_added: ${{ steps.analyze.outputs.labels_added }}
      estimated_cardinality: ${{ steps.analyze.outputs.estimated_cardinality }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Detect metrics changes
        id: detect
        run: |
          # æ£€æµ‹æ˜¯å¦æœ‰æŒ‡æ ‡ç›¸å…³å˜æ›´
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          HAS_CHANGES=false
          for file in $CHANGED_FILES; do
            if [[ "$file" == *"metrics"* ]] || [[ "$file" == *"prometheus"* ]]; then
              HAS_CHANGES=true
              break
            fi
          done

          echo "has_changes=${HAS_CHANGES}" >> $GITHUB_OUTPUT

          if [ "$HAS_CHANGES" = "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°æŒ‡æ ‡ç›¸å…³å˜æ›´"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æŒ‡æ ‡ç›¸å…³å˜æ›´"
          fi

      - name: Analyze metrics impact
        id: analyze
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          # åˆ†æžæ–°å¢žçš„æŒ‡æ ‡å’Œæ ‡ç­¾
          cat > analyze_metrics.py << 'EOF'
          import re
          import sys
          import subprocess
          import json

          def extract_metrics_from_diff():
              """ä»Žgit diffä¸­æå–æ–°å¢žçš„æŒ‡æ ‡"""
              try:
                  result = subprocess.run(
                      ["git", "diff", "origin/${{ github.base_ref }}...HEAD", "--unified=0"],
                      capture_output=True, text=True
                  )

                  metrics_added = set()
                  labels_added = set()

                  # æŸ¥æ‰¾PrometheusæŒ‡æ ‡å®šä¹‰
                  metric_pattern = re.compile(r'\+.*(?:Counter|Gauge|Histogram|Summary)\(["\']([^"\']+)')
                  label_pattern = re.compile(r'labels?\s*=\s*\[([^\]]+)\]')

                  for line in result.stdout.split('\n'):
                      if line.startswith('+'):
                          # æŸ¥æ‰¾æŒ‡æ ‡
                          metric_match = metric_pattern.search(line)
                          if metric_match:
                              metrics_added.add(metric_match.group(1))

                          # æŸ¥æ‰¾æ ‡ç­¾
                          label_match = label_pattern.search(line)
                          if label_match:
                              labels = label_match.group(1).replace('"', '').replace("'", '')
                              for label in labels.split(','):
                                  labels_added.add(label.strip())

                  return list(metrics_added), list(labels_added)
              except Exception as e:
                  print(f"Error: {e}")
                  return [], []

          def estimate_cardinality(metrics, labels):
              """ä¼°ç®—åŸºæ•°å¢žé•¿"""
              # ç®€å•ä¼°ç®—ï¼šæ¯ä¸ªæŒ‡æ ‡ * æ¯ä¸ªæ ‡ç­¾çš„å¯èƒ½å€¼
              base_cardinality = len(metrics) * 100  # å‡è®¾æ¯ä¸ªæŒ‡æ ‡100ä¸ªåºåˆ—
              label_multiplier = 1

              for label in labels:
                  if 'id' in label.lower() or 'uuid' in label.lower():
                      label_multiplier *= 1000  # IDç±»æ ‡ç­¾
                  elif 'user' in label.lower():
                      label_multiplier *= 100   # ç”¨æˆ·æ ‡ç­¾
                  elif 'path' in label.lower() or 'url' in label.lower():
                      label_multiplier *= 50    # è·¯å¾„æ ‡ç­¾
                  else:
                      label_multiplier *= 10    # æ™®é€šæ ‡ç­¾

              return min(base_cardinality * label_multiplier, 1000000)

          # æ‰§è¡Œåˆ†æž
          metrics, labels = extract_metrics_from_diff()
          cardinality = estimate_cardinality(metrics, labels)

          print(f"æ–°å¢žæŒ‡æ ‡: {len(metrics)}")
          print(f"æ–°å¢žæ ‡ç­¾: {len(labels)}")
          print(f"é¢„ä¼°åŸºæ•°: {cardinality}")

          # è¾“å‡ºåˆ°GitHubçŽ¯å¢ƒ
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"metrics_added={len(metrics)}\n")
              f.write(f"labels_added={len(labels)}\n")
              f.write(f"estimated_cardinality={cardinality}\n")

          # ä¿å­˜è¯¦ç»†ä¿¡æ¯
          with open('metrics_analysis.json', 'w') as f:
              json.dump({
                  'metrics': metrics,
                  'labels': labels,
                  'estimated_cardinality': cardinality
              }, f, indent=2)
          EOF

          python analyze_metrics.py

      - name: Upload analysis results
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: metrics-analysis
          path: metrics_analysis.json

  check-cardinality-budget:
    name: Check Cardinality Budget
    needs: analyze-metrics-changes
    if: needs.analyze-metrics-changes.outputs.has_metrics_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      budget_status: ${{ steps.budget.outputs.status }}
      budget_usage: ${{ steps.budget.outputs.usage_percentage }}
      budget_exceeded: ${{ steps.budget.outputs.exceeded }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check current budget usage
        id: budget
        run: |
          # è¿è¡Œé¢„ç®—æ£€æŸ¥
          python scripts/metrics_budget_controller.py \
            --status \
            --output budget_status.json || true

          # è§£æžç»“æžœ
          if [ -f budget_status.json ]; then
            USAGE=$(jq -r '.global_usage_percentage' budget_status.json)
            STATUS=$(jq -r '.global_status' budget_status.json)

            # åŠ ä¸Šé¢„ä¼°çš„æ–°å¢žåŸºæ•°
            NEW_CARDINALITY=${{ needs.analyze-metrics-changes.outputs.estimated_cardinality }}
            TOTAL_BUDGET=1000000  # é»˜è®¤æ€»é¢„ç®—
            ADDITIONAL_USAGE=$((NEW_CARDINALITY * 100 / TOTAL_BUDGET))
            PROJECTED_USAGE=$((USAGE + ADDITIONAL_USAGE))

            echo "å½“å‰ä½¿ç”¨: ${USAGE}%"
            echo "é¢„è®¡æ–°å¢ž: ${ADDITIONAL_USAGE}%"
            echo "é¢„è®¡æ€»è®¡: ${PROJECTED_USAGE}%"

            EXCEEDED=false
            if [ $PROJECTED_USAGE -gt $BUDGET_THRESHOLD ]; then
              EXCEEDED=true
              echo "âš ï¸ é¢„ç®—å³å°†è¶…é™ï¼"
            fi

            echo "status=${STATUS}" >> $GITHUB_OUTPUT
            echo "usage_percentage=${PROJECTED_USAGE}" >> $GITHUB_OUTPUT
            echo "exceeded=${EXCEEDED}" >> $GITHUB_OUTPUT
          else
            # å¦‚æžœæ— æ³•èŽ·å–å½“å‰çŠ¶æ€ï¼Œä½¿ç”¨ä¿å®ˆä¼°è®¡
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "usage_percentage=0" >> $GITHUB_OUTPUT
            echo "exceeded=false" >> $GITHUB_OUTPUT
          fi

  calculate-cost-impact:
    name: Calculate Cost Impact
    needs: analyze-metrics-changes
    if: needs.analyze-metrics-changes.outputs.has_metrics_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      monthly_cost_increase: ${{ steps.cost.outputs.monthly_increase }}
      yearly_cost_increase: ${{ steps.cost.outputs.yearly_increase }}

    steps:
      - name: Calculate costs
        id: cost
        run: |
          # è®¡ç®—æˆæœ¬å½±å“
          CARDINALITY=${{ needs.analyze-metrics-changes.outputs.estimated_cardinality }}
          COST_PER_SERIES=0.001  # $0.001 per series per month

          MONTHLY=$(echo "$CARDINALITY * $COST_PER_SERIES" | bc -l)
          YEARLY=$(echo "$MONTHLY * 12" | bc -l)

          # æ ¼å¼åŒ–ä¸º2ä½å°æ•°
          MONTHLY_FMT=$(printf "%.2f" $MONTHLY)
          YEARLY_FMT=$(printf "%.2f" $YEARLY)

          echo "monthly_increase=${MONTHLY_FMT}" >> $GITHUB_OUTPUT
          echo "yearly_increase=${YEARLY_FMT}" >> $GITHUB_OUTPUT

          echo "ðŸ’° é¢„è®¡æˆæœ¬å¢žåŠ :"
          echo "   æœˆåº¦: \$${MONTHLY_FMT}"
          echo "   å¹´åº¦: \$${YEARLY_FMT}"

  generate-optimization-suggestions:
    name: Generate Optimization Suggestions
    needs: [analyze-metrics-changes, check-cardinality-budget]
    if: needs.analyze-metrics-changes.outputs.has_metrics_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Download analysis
        uses: actions/download-artifact@v3
        with:
          name: metrics-analysis

      - name: Generate suggestions
        run: |
          # ç”Ÿæˆä¼˜åŒ–å»ºè®®
          cat > generate_suggestions.py << 'EOF'
          import json

          with open('metrics_analysis.json', 'r') as f:
              data = json.load(f)

          suggestions = []

          # åˆ†æžæ ‡ç­¾
          for label in data.get('labels', []):
              if 'id' in label.lower() or 'uuid' in label.lower():
                  suggestions.append(f"âš ï¸ è€ƒè™‘åˆ é™¤é«˜åŸºæ•°æ ‡ç­¾ '{label}'")
              elif 'user' in label.lower():
                  suggestions.append(f"ðŸ’¡ è€ƒè™‘å¯¹ '{label}' ä½¿ç”¨é‡‡æ ·æˆ–èšåˆ")
              elif 'path' in label.lower() or 'url' in label.lower():
                  suggestions.append(f"ðŸ”§ è€ƒè™‘è§„èŒƒåŒ– '{label}' ä¸ºè·¯å¾„æ¨¡å¼")

          # åŸºäºŽåŸºæ•°çš„å»ºè®®
          cardinality = data.get('estimated_cardinality', 0)
          if cardinality > 10000:
              suggestions.append("ðŸ“Š è€ƒè™‘ä½¿ç”¨ Recording Rules é¢„èšåˆ")
          if cardinality > 5000:
              suggestions.append("ðŸ“‰ è€ƒè™‘åº”ç”¨é™é‡‡æ ·ç­–ç•¥")

          if suggestions:
              print("## ðŸŽ¯ ä¼˜åŒ–å»ºè®®\n")
              for s in suggestions:
                  print(f"- {s}")
          else:
              print("âœ… æŒ‡æ ‡è®¾è®¡åˆç†ï¼Œæ— éœ€ä¼˜åŒ–")
          EOF

          python generate_suggestions.py > suggestions.md

      - name: Save suggestions
        uses: actions/upload-artifact@v3
        with:
          name: optimization-suggestions
          path: suggestions.md

  post-pr-comment:
    name: Post PR Comment
    needs: [analyze-metrics-changes, check-cardinality-budget, calculate-cost-impact, generate-optimization-suggestions]
    if: needs.analyze-metrics-changes.outputs.has_metrics_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3

      - name: Create comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // è¯»å–å»ºè®®
            let suggestions = '';
            try {
              suggestions = fs.readFileSync('optimization-suggestions/suggestions.md', 'utf8');
            } catch (e) {
              suggestions = 'âœ… æ— ä¼˜åŒ–å»ºè®®';
            }

            // æž„å»ºè¯„è®º
            const metricsAdded = '${{ needs.analyze-metrics-changes.outputs.metrics_added }}';
            const labelsAdded = '${{ needs.analyze-metrics-changes.outputs.labels_added }}';
            const cardinality = '${{ needs.analyze-metrics-changes.outputs.estimated_cardinality }}';
            const budgetStatus = '${{ needs.check-cardinality-budget.outputs.budget_status }}';
            const budgetUsage = '${{ needs.check-cardinality-budget.outputs.budget_usage }}';
            const monthlyIncrease = '${{ needs.calculate-cost-impact.outputs.monthly_cost_increase }}';
            const yearlyIncrease = '${{ needs.calculate-cost-impact.outputs.yearly_cost_increase }}';

            const statusEmoji = {
              'healthy': 'âœ…',
              'warning': 'âš ï¸',
              'critical': 'ðŸ”´',
              'exceeded': 'ðŸš¨'
            }[budgetStatus] || 'â“';

            const comment = `## ðŸ“Š Metrics Budget Impact Analysis

            ### ðŸ“ˆ Changes Detected
            - **New Metrics**: ${metricsAdded || 0}
            - **New Labels**: ${labelsAdded || 0}
            - **Estimated New Time Series**: ${parseInt(cardinality).toLocaleString()}

            ### ðŸ’° Cost Impact
            - **Monthly Cost Increase**: \$${monthlyIncrease}
            - **Yearly Cost Increase**: \$${yearlyIncrease}

            ### ðŸŽ¯ Budget Status
            - **Status**: ${statusEmoji} ${budgetStatus}
            - **Projected Usage**: ${budgetUsage}%
            ${budgetUsage > 90 ? '- **âš ï¸ Warning**: Budget usage will exceed 90%' : ''}

            ${suggestions}

            ### ðŸ“‹ Checklist
            - [ ] Review high-cardinality labels
            - [ ] Consider using recording rules for aggregations
            - [ ] Validate that new metrics are necessary
            - [ ] Update dashboards and alerts if needed

            ---
            *ðŸ¤– Generated by Metrics Budget Check*`;

            // å‘å¸ƒè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  block-if-over-budget:
    name: Block if Over Budget
    needs: check-cardinality-budget
    if: needs.check-cardinality-budget.outputs.budget_exceeded == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Block PR
        run: |
          echo "ðŸš¨ PRè¢«é˜»æ­¢ï¼šæŒ‡æ ‡é¢„ç®—è¶…é™ï¼"
          echo ""
          echo "é¢„è®¡ä½¿ç”¨çŽ‡: ${{ needs.check-cardinality-budget.outputs.budget_usage }}%"
          echo "é˜ˆå€¼: ${{ env.BUDGET_THRESHOLD }}%"
          echo ""
          echo "è¯·ä¼˜åŒ–æŒ‡æ ‡è®¾è®¡æˆ–ç”³è¯·é¢„ç®—å¢žåŠ ã€‚"
          exit 1

  summary:
    name: Generate Summary
    needs: [analyze-metrics-changes, check-cardinality-budget, calculate-cost-impact]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate job summary
        run: |
          echo "# ðŸ“Š Metrics Budget Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.analyze-metrics-changes.outputs.has_metrics_changes }}" = "true" ]; then
            echo "## ðŸ“ˆ Metrics Changes" >> $GITHUB_STEP_SUMMARY
            echo "- New Metrics: ${{ needs.analyze-metrics-changes.outputs.metrics_added }}" >> $GITHUB_STEP_SUMMARY
            echo "- New Labels: ${{ needs.analyze-metrics-changes.outputs.labels_added }}" >> $GITHUB_STEP_SUMMARY
            echo "- Estimated Cardinality: ${{ needs.analyze-metrics-changes.outputs.estimated_cardinality }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "## ðŸ’° Cost Impact" >> $GITHUB_STEP_SUMMARY
            echo "- Monthly: \$${{ needs.calculate-cost-impact.outputs.monthly_cost_increase }}" >> $GITHUB_STEP_SUMMARY
            echo "- Yearly: \$${{ needs.calculate-cost-impact.outputs.yearly_cost_increase }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "## ðŸŽ¯ Budget Status" >> $GITHUB_STEP_SUMMARY
            echo "- Status: ${{ needs.check-cardinality-budget.outputs.budget_status }}" >> $GITHUB_STEP_SUMMARY
            echo "- Usage: ${{ needs.check-cardinality-budget.outputs.budget_usage }}%" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.check-cardinality-budget.outputs.budget_exceeded }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Warning: Budget threshold exceeded!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… No metrics changes detected" >> $GITHUB_STEP_SUMMARY
          fi