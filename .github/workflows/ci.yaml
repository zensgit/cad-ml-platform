name: CAD Platform CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-l3.txt
        pip install httpx pytest
        
    - name: Run Unit Tests (Core)
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        python -m unittest discover -s tests -p "test_*.py"
        
    - name: Run L4 Integration Tests
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        # Assuming we mock heavy libs, this verifies the wiring
        python -m unittest tests/test_api_integration.py
