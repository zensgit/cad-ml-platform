name: Release Risk Assessment

on:
  pull_request:
    branches:
      - main
      - master
      - production
      - release/*
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch for comparison'
        required: false
        default: 'main'

jobs:
  risk-assessment:
    name: Assess Release Risk
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥è¿›è¡Œæ¯”è¾ƒ

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests and collect results
        id: test
        continue-on-error: true
        run: |
          # è¿è¡Œæµ‹è¯•
          if [ -d tests ]; then
            python -m pytest tests/ \
              --junitxml=test-results.xml \
              --cov=src \
              --cov-report=xml \
              --cov-report=term \
              || true
          fi

          # å¯¼å‡ºæµ‹è¯•ç»“æœåˆ°ç¯å¢ƒå˜é‡
          if [ -f test-results.xml ]; then
            TOTAL=$(grep -o 'tests="[0-9]*"' test-results.xml | grep -o '[0-9]*' | head -1)
            FAILED=$(grep -o 'failures="[0-9]*"' test-results.xml | grep -o '[0-9]*' | head -1)
            ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | grep -o '[0-9]*' | head -1)
            SKIPPED=$(grep -o 'skipped="[0-9]*"' test-results.xml | grep -o '[0-9]*' | head -1)

            echo "TEST_TOTAL=${TOTAL:-0}" >> $GITHUB_ENV
            echo "TEST_FAILED=${FAILED:-0}" >> $GITHUB_ENV
            echo "TEST_ERRORS=${ERRORS:-0}" >> $GITHUB_ENV
            echo "TEST_SKIPPED=${SKIPPED:-0}" >> $GITHUB_ENV
            echo "TEST_PASSED=$((${TOTAL:-0} - ${FAILED:-0} - ${ERRORS:-0} - ${SKIPPED:-0}))" >> $GITHUB_ENV
          fi

      - name: Calculate Release Risk
        id: risk
        run: |
          # ç¡®å®šåŸºå‡†åˆ†æ”¯
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_BRANCH="${{ github.base_ref }}"
          else
            BASE_BRANCH="${{ github.event.inputs.base_branch }}"
          fi

          echo "åŸºå‡†åˆ†æ”¯: $BASE_BRANCH"

          # è¿è¡Œé£é™©è¯„åˆ†
          python scripts/release_risk_scorer.py \
            --base-branch "${BASE_BRANCH}" \
            --output-format json \
            --output-file risk_report.json

          # æå–å…³é”®ä¿¡æ¯
          RISK_SCORE=$(jq -r '.score' risk_report.json)
          RISK_LEVEL=$(jq -r '.level' risk_report.json)
          BLOCKING=$(jq -r '.blocking' risk_report.json)

          echo "risk_score=${RISK_SCORE}" >> $GITHUB_OUTPUT
          echo "risk_level=${RISK_LEVEL}" >> $GITHUB_OUTPUT
          echo "blocking=${BLOCKING}" >> $GITHUB_OUTPUT

          # ç”ŸæˆMarkdownæŠ¥å‘Š
          python scripts/release_risk_scorer.py \
            --base-branch "${BASE_BRANCH}" \
            --output-format markdown \
            --output-file risk_report.md

      - name: Comment PR with Risk Report
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // è¯»å–æŠ¥å‘Š
            const report = JSON.parse(fs.readFileSync('risk_report.json', 'utf8'));
            const markdown = fs.readFileSync('risk_report.md', 'utf8');

            // é€‰æ‹©åˆé€‚çš„emojiå’Œæ ‡ç­¾
            let emoji, label;
            if (report.level === 'LOW') {
              emoji = 'âœ…';
              label = 'risk:low';
            } else if (report.level === 'MEDIUM') {
              emoji = 'âš ï¸';
              label = 'risk:medium';
            } else if (report.level === 'HIGH') {
              emoji = 'ğŸŸ ';
              label = 'risk:high';
            } else {
              emoji = 'ğŸ”´';
              label = 'risk:critical';
            }

            // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
            const commentBody = `## ${emoji} Release Risk Assessment\n\n${markdown}`;

            // æŸ¥æ‰¾ç°æœ‰çš„é£é™©è¯„ä¼°è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Release Risk Assessment')
            );

            try {
              if (botComment) {
                // æ›´æ–°ç°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
              }
            } catch (error) {
              console.log(`Failed to post PR comment: ${error.message}`);
            }

            // æ·»åŠ æˆ–æ›´æ–°æ ‡ç­¾
            try {
              // ç§»é™¤æ—§çš„é£é™©æ ‡ç­¾
              const currentLabels = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              const riskLabels = currentLabels.data
                .filter(l => l.name.startsWith('risk:'))
                .map(l => l.name);

              if (riskLabels.length > 0) {
                for (const oldLabel of riskLabels) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: oldLabel
                  });
                }
              }

              // æ·»åŠ æ–°çš„é£é™©æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [label]
              });
            } catch (error) {
              console.log('æ— æ³•æ·»åŠ æ ‡ç­¾ï¼ˆå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ï¼‰:', error.message);
            }

      - name: Upload Risk Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: risk-assessment-report
          path: |
            risk_report.json
            risk_report.md
            test-results.xml
            coverage.xml

      - name: Check if should block
        if: steps.risk.outputs.blocking == 'true'
        run: |
          echo "â›” å‘å¸ƒè¢«é˜»æ–­ï¼é£é™©è¯„åˆ†è¿‡é«˜: ${{ steps.risk.outputs.risk_score }}"
          echo ""
          echo "é™ä½é£é™©çš„å»ºè®®:"
          echo "1. å¢åŠ æµ‹è¯•è¦†ç›–ç‡"
          echo "2. å‡å°‘å•æ¬¡å˜æ›´é‡"
          echo "3. ä¿®å¤å¤±è´¥çš„æµ‹è¯•"
          echo "4. è€ƒè™‘åˆ†æ‰¹å‘å¸ƒ"
          echo ""
          echo "å¦‚éœ€å¼ºåˆ¶å‘å¸ƒï¼Œè¯·è·å¾—ç®¡ç†å‘˜æ‰¹å‡†ã€‚"
          exit 1

      - name: Post status check
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const score = '${{ steps.risk.outputs.risk_score }}';
            const level = '${{ steps.risk.outputs.risk_level }}';
            const blocking = '${{ steps.risk.outputs.blocking }}' === 'true';

            let state, description;
            if (level === 'LOW') {
              state = 'success';
              description = `ä½é£é™© (${score}/100) - å¯ä»¥å®‰å…¨å‘å¸ƒ`;
            } else if (level === 'MEDIUM') {
              state = 'success';
              description = `ä¸­é£é™© (${score}/100) - è¯·æ³¨æ„ç›‘æ§`;
            } else if (level === 'HIGH' && !blocking) {
              state = 'warning';
              description = `é«˜é£é™© (${score}/100) - å»ºè®®è°¨æ…å‘å¸ƒ`;
            } else {
              state = 'failure';
              description = `æé«˜é£é™© (${score}/100) - å‘å¸ƒå·²é˜»æ–­`;
            }

            // åˆ›å»ºçŠ¶æ€æ£€æŸ¥ï¼ˆåœ¨æƒé™ä¸è¶³æ—¶ä»…è®°å½•è­¦å‘Šï¼‰
            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: state,
                target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                description: description,
                context: 'Release Risk Assessment'
              });
            } catch (error) {
              console.log(`Failed to create commit status: ${error.message}`);
            }

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ“Š é£é™©è¯„ä¼°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **é£é™©åˆ†æ•°**: ${{ steps.risk.outputs.risk_score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **é£é™©ç­‰çº§**: ${{ steps.risk.outputs.risk_level }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦é˜»æ–­**: ${{ steps.risk.outputs.blocking }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†æŠ¥å‘Šå·²ä½œä¸ºartifactä¸Šä¼ ï¼Œå¯ä»¥ä¸‹è½½æŸ¥çœ‹ã€‚" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šSlacké€šçŸ¥
  slack-notification:
    name: Slack Notification
    needs: risk-assessment
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.risk-assessment.outputs.risk_level }}" == "CRITICAL" ]; then
            curl -X POST $SLACK_WEBHOOK_URL \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "ğŸ”´ é«˜é£é™©å‘å¸ƒè­¦å‘Š",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âš ï¸ é«˜é£é™©å‘å¸ƒæ£€æµ‹"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*PR*: <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>\n*é£é™©åˆ†æ•°*: ${{ needs.risk-assessment.outputs.risk_score }}/100\n*é£é™©ç­‰çº§*: ${{ needs.risk-assessment.outputs.risk_level }}"
                    }
                  }
                ]
              }'
          fi
