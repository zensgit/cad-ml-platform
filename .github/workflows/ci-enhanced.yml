name: CI Enhanced

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  CACHE_VERSION: v1

jobs:
  # ============================================
  # Stage 1: Quick checks (parallel)
  # ============================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-lint-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements*.txt') }}
          restore-keys: pip-lint-${{ env.CACHE_VERSION }}-
      - name: Install linters
        run: pip install ruff black isort flake8
      - name: Run ruff
        run: ruff check src/ tests/ --output-format=github
        continue-on-error: true
      - name: Check formatting (black)
        run: black --check src/ tests/ || true
      - name: Check imports (isort)
        run: isort --check-only src/ tests/ || true

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-mypy-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements*.txt') }}
          restore-keys: pip-mypy-${{ env.CACHE_VERSION }}-
      - name: Cache mypy
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ env.CACHE_VERSION }}-${{ hashFiles('src/**/*.py') }}
          restore-keys: mypy-${{ env.CACHE_VERSION }}-
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
          pip install mypy types-redis types-requests
      - name: Run mypy
        run: mypy src/ --ignore-missing-imports --no-error-summary || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install security tools
        run: pip install bandit safety pip-audit
      - name: Run Bandit (SAST)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt --severity-level medium || true
      - name: Check dependencies (Safety)
        run: safety check -r requirements.txt --output json > safety-report.json || true
        continue-on-error: true
      - name: Check dependencies (pip-audit)
        run: pip-audit -r requirements.txt --format json > pip-audit-report.json || true
        continue-on-error: true
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json

  # ============================================
  # Stage 2: Unit tests (parallel shards)
  # ============================================
  unit-tests:
    name: Unit Tests (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-test-${{ env.CACHE_VERSION }}-${{ matrix.python-version }}-${{ hashFiles('requirements*.txt') }}
          restore-keys: pip-test-${{ env.CACHE_VERSION }}-${{ matrix.python-version }}-
      - name: Cache pytest
        uses: actions/cache@v4
        with:
          path: .pytest_cache
          key: pytest-${{ env.CACHE_VERSION }}-${{ matrix.python-version }}-${{ matrix.shard }}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
          pip install pytest-split
      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: |
          pytest tests/unit/ \
            --splits 4 \
            --group ${{ matrix.shard }} \
            --splitting-algorithm least_duration \
            -v --tb=short \
            --junitxml=junit-${{ matrix.python-version }}-${{ matrix.shard }}.xml \
            || true
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}-${{ matrix.shard }}
          path: junit-*.xml
      - name: Run knowledge tests
        run: make test-knowledge
      - name: Upload knowledge test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-test-report-${{ matrix.python-version }}
          path: reports/junit-knowledge.xml

  # ============================================
  # Stage 3: Integration tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-integration-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements*.txt') }}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
      - name: Run integration tests
        run: pytest tests/integration/ -v --tb=short || true

  # ============================================
  # Stage 4: Coverage report
  # ============================================
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
          pip install coverage pytest-cov
      - name: Run tests with coverage
        run: |
          pytest tests/unit/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -q || true
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

  # ============================================
  # Stage 5: Build validation
  # ============================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, type-check]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: cad-ml-platform:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production

  # ============================================
  # Summary job
  # ============================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, type-check, security-scan, unit-tests, integration-tests, coverage, build]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
