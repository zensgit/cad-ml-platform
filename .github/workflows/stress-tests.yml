name: Stress Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/stress_*.py'
      - '.github/workflows/stress-tests.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/stress_*.py'
      - '.github/workflows/stress-tests.yml'
  # Allow manual trigger for on-demand stress testing
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - stress-only
          - integration-only
      python_version:
        description: 'Python version'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.10'
          - '3.11'

jobs:
  stress-unit-tests:
    name: Stress & Stability Unit Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', inputs.python_version)) || fromJSON('["3.10", "3.11"]') }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run full unit test suite
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.test_scope == 'full' }}
        run: |
          pytest tests/unit -v --tb=short -q

      - name: Run stress stability integration tests
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.test_scope != 'integration-only' }}
        run: |
          pytest tests/integration/test_stress_stability.py -v --tb=short

      - name: Run v4 feature tests
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.test_scope == 'full' }}
        run: |
          pytest tests/unit/test_v4_features*.py -v --tb=short

      - name: Validate stress scripts importable
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Validate scripts can be imported without errors
          import importlib.util

          scripts = [
              'scripts/stress_concurrency_reload.py',
              'scripts/stress_memory_gc_check.py',
              'scripts/stress_degradation_flapping.py',
          ]

          for script_path in scripts:
              spec = importlib.util.spec_from_file_location('test_module', script_path)
              module = importlib.util.module_from_spec(spec)
              spec.loader.exec_module(module)
              print(f'âœ“ {script_path} importable')

              # Verify main function exists
              assert hasattr(module, 'main'), f'{script_path} missing main()'
              print(f'  â””â”€ main() function verified')

          print('All stress scripts validated successfully')
          "

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results-py${{ matrix.python-version }}
          path: |
            .pytest_cache/
            reports/
          retention-days: 7

  metrics-consistency:
    name: Metrics Consistency Check
    runs-on: ubuntu-latest
    needs: stress-unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run metrics consistency check
        run: |
          python scripts/metrics_consistency_check.py

      - name: Install promtool (optional)
        continue-on-error: true
        run: |
          # Try to install promtool for formal rule validation
          PROMETHEUS_VERSION="2.48.0"
          wget -q "https://github.com/prometheus/prometheus/releases/download/v${PROMETHEUS_VERSION}/prometheus-${PROMETHEUS_VERSION}.linux-amd64.tar.gz" -O /tmp/prometheus.tar.gz || exit 0
          tar -xzf /tmp/prometheus.tar.gz -C /tmp || exit 0
          sudo mv /tmp/prometheus-${PROMETHEUS_VERSION}.linux-amd64/promtool /usr/local/bin/ || exit 0
          promtool --version && echo "promtool installed successfully"

      - name: Validate Prometheus rules syntax
        run: |
          # Use promtool if available for formal validation, otherwise fall back to YAML check
          if command -v promtool &> /dev/null; then
            echo "Using promtool for formal rule validation..."
            promtool check rules prometheus/rules/cad_ml_phase5_alerts.yaml
            echo "âœ“ Prometheus rules validated with promtool"
          else
            echo "promtool not available, using YAML validation..."
            python -c "
            import yaml
            with open('prometheus/rules/cad_ml_phase5_alerts.yaml', 'r') as f:
                rules = yaml.safe_load(f)
            print(f'âœ“ Prometheus rules YAML valid')
            print(f'  Groups: {len(rules.get(\"groups\", []))}')
            for g in rules.get('groups', []):
                print(f'    - {g[\"name\"]}: {len(g.get(\"rules\", []))} rules')
            "
          fi

      - name: Validate Grafana dashboard JSON
        run: |
          python -c "
          import json
          with open('grafana/dashboards/observability.json', 'r') as f:
              dashboard = json.load(f)
          print(f'âœ“ Grafana dashboard JSON valid')
          print(f'  Title: {dashboard.get(\"title\")}')
          print(f'  Panels: {len(dashboard.get(\"panels\", []))}')
          "

  stress-report:
    name: Generate Stress Test Report
    runs-on: ubuntu-latest
    needs: [stress-unit-tests, metrics-consistency]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate summary report
        run: |
          echo "## ðŸ”¥ Stress Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.stress-unit-tests.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Metrics Consistency | ${{ needs.metrics-consistency.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Concurrent reload stress tests" >> $GITHUB_STEP_SUMMARY
          echo "- Memory stability and GC tests" >> $GITHUB_STEP_SUMMARY
          echo "- Degradation state management" >> $GITHUB_STEP_SUMMARY
          echo "- Feature extraction concurrency" >> $GITHUB_STEP_SUMMARY
          echo "- Cache stress tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Observability Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Prometheus alert rules syntax" >> $GITHUB_STEP_SUMMARY
          echo "- Grafana dashboard JSON" >> $GITHUB_STEP_SUMMARY
          echo "- Metrics consistency check" >> $GITHUB_STEP_SUMMARY
