name: SBOM Generation and Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'Pipfile*'
      - '.github/workflows/sbom.yml'
  pull_request:
    branches: [main]
  schedule:
    # Weekly SBOM generation - Sunday at 2 AM
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      upload_artifact:
        description: 'Upload SBOM as artifact'
        required: false
        default: 'true'
        type: boolean

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
      id-token: write  # Required for keyless signing with Sigstore

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install cyclonedx-bom pip-licenses

      - name: Generate CycloneDX SBOM (JSON)
        run: |
          pip install -r requirements.txt
          cyclonedx-py requirements requirements.txt -o sbom-cyclonedx.json --of JSON

      - name: Generate CycloneDX SBOM (XML)
        run: |
          cyclonedx-py requirements requirements.txt -o sbom-cyclonedx.xml --of XML

      - name: Generate SPDX SBOM
        run: |
          pip install spdx-tools
          python scripts/generate_spdx_sbom.py \
            --output sbom-spdx.json

      - name: Generate License Report
        run: |
          pip-licenses --format=json \
            --with-urls \
            --with-description \
            --output-file=licenses.json

          pip-licenses --format=markdown \
            --with-urls \
            --output-file=licenses.md

      - name: Scan SBOM for vulnerabilities
        uses: anchore/scan-action@v3
        with:
          path: "."
          fail-build: false
          output-format: json
          severity-cutoff: high

      - name: Upload SBOM to GitHub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom-github.json

      - name: Sign SBOM with Cosign
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Install cosign
          curl -Lo cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign

          # Sign SBOM files with keyless signing using GitHub OIDC
          ./cosign sign-blob --yes --oidc-issuer https://token.actions.githubusercontent.com \
            --bundle sbom-cyclonedx.json.bundle sbom-cyclonedx.json
          ./cosign sign-blob --yes --oidc-issuer https://token.actions.githubusercontent.com \
            --bundle sbom-cyclonedx.xml.bundle sbom-cyclonedx.xml

      - name: Check for high-risk dependencies
        run: |
          python scripts/check_supply_chain_risk.py \
            --sbom sbom-cyclonedx.json \
            --output risk-report.json

      - name: Create SBOM summary
        run: |
          echo "# ðŸ“¦ SBOM Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count components
          echo "## Component Statistics" >> $GITHUB_STEP_SUMMARY
          COMPONENT_COUNT=$(jq '.components | length' sbom-cyclonedx.json)
          echo "- Total Components: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY

          # License summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## License Distribution" >> $GITHUB_STEP_SUMMARY
          jq -r '.[].License' licenses.json | sort | uniq -c | sort -rn | head -10 | \
            awk '{print "- " $2 ": " $1}' >> $GITHUB_STEP_SUMMARY

          # Vulnerability summary if exists
          if [ -f vulnerability-report.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="Critical")] | length' vulnerability-report.json)
            HIGH=$(jq '[.vulnerabilities[] | select(.severity=="High")] | length' vulnerability-report.json)
            MEDIUM=$(jq '[.vulnerabilities[] | select(.severity=="Medium")] | length' vulnerability-report.json)
            LOW=$(jq '[.vulnerabilities[] | select(.severity=="Low")] | length' vulnerability-report.json)
            echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- Low: $LOW" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload SBOM artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts-${{ github.sha }}
          path: |
            sbom-*.json
            sbom-*.xml
            sbom-*.bundle
            licenses.json
            licenses.md
            risk-report.json
          retention-days: 90

      - name: Cache SBOM for comparison
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache@v4
        with:
          path: |
            .sbom-cache/
          key: sbom-${{ github.sha }}
          restore-keys: |
            sbom-

  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: generate-sbom

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom-artifacts-${{ github.sha }}

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'CAD ML Platform'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --suppression dependency-check-suppression.xml

      - name: Upload Dependency Check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: generate-sbom

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-artifacts-${{ github.sha }}

      - name: Run Trivy SBOM scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom-cyclonedx.json'
          format: 'json'
          output: 'trivy-sbom-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true

      - name: Generate Trivy summary
        run: |
          echo "## ðŸ” Trivy SBOM Scan Results" >> $GITHUB_STEP_SUMMARY
          jq -r '.Results[] | .Vulnerabilities[]? | "- \(.Severity): \(.PkgName) - \(.Title)"' trivy-sbom-report.json >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY

      - name: Upload Trivy results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sbom-report
          path: trivy-sbom-report.json

  sbom-diff:
    name: SBOM Diff Analysis
    runs-on: ubuntu-latest
    needs: generate-sbom
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download current SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-artifacts-${{ github.sha }}

      - name: Generate base branch SBOM
        run: |
          git checkout ${{ github.base_ref }}
          pip install cyclonedx-bom
          pip install -r requirements.txt
          cyclonedx-py requirements \
            --input-file requirements.txt \
            --output-format json \
            --outfile sbom-base.json

      - name: Compare SBOMs
        run: |
          git checkout ${{ github.head_ref }}
          python scripts/compare_sboms.py \
            --base sbom-base.json \
            --current sbom-cyclonedx.json \
            --output sbom-diff.md

      - name: Comment PR with diff
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const diffContent = fs.readFileSync('sbom-diff.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('SBOM Dependency Changes')
            );

            const body = `## ðŸ“¦ SBOM Dependency Changes\n\n${diffContent}`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }