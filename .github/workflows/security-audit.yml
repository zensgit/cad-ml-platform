name: Security Audit

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'low'
        type: choice
        options:
          - critical
          - high
          - medium
          - low

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pip-audit safety bandit

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          echo "Running pip-audit for dependency vulnerabilities..."
          pip-audit --format json --output audit-report.json || true

          # Parse results and determine severity
          if [ -f audit-report.json ]; then
            CRITICAL_COUNT=$(jq '[.vulnerabilities[] | select(.fix_versions != null and .aliases[] | contains("critical"))] | length' audit-report.json 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.vulnerabilities[] | select(.fix_versions != null and .aliases[] | contains("high"))] | length' audit-report.json 2>/dev/null || echo "0")

            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

            # Exit code based on severity
            if [ "$CRITICAL_COUNT" -gt "0" ]; then
              echo "::error::Found $CRITICAL_COUNT critical vulnerabilities"
              exit 3
            elif [ "$HIGH_COUNT" -gt "0" ]; then
              echo "::warning::Found $HIGH_COUNT high severity vulnerabilities"
              exit 4
            fi
          fi

      - name: Run safety check
        id: safety
        continue-on-error: true
        run: |
          echo "Running safety check for known security issues..."
          safety check --json --output safety-report.json || true

      - name: Run bandit security scan
        id: bandit
        continue-on-error: true
        run: |
          echo "Running bandit for code security issues..."
          # Exclude vision module (contains legitimate security/crypto code that triggers false positives)
          # Exclude OCR module (contains legitimate image processing code)
          bandit -r src/ --exclude src/core/vision,src/core/ocr -f json -o bandit-report.json || true

          HIGH_ISSUES="0"
          TOTAL_ISSUES="0"
          if [ -f bandit-report.json ]; then
            HIGH_ISSUES=$(jq '.results | map(select(.issue_severity == "HIGH")) | length' bandit-report.json)
            TOTAL_ISSUES=$(jq '.results | length' bandit-report.json)
          fi

          BASELINE_HIGH="0"
          BASELINE_TOTAL="0"
          if [ -f config/security_audit_bandit_baseline.json ]; then
            BASELINE_HIGH=$(jq '.bandit.high_code_issues // 0' config/security_audit_bandit_baseline.json 2>/dev/null || echo "0")
            BASELINE_TOTAL=$(jq '.bandit.total_issues // 0' config/security_audit_bandit_baseline.json 2>/dev/null || echo "0")
          fi

          HIGH_DELTA=$((HIGH_ISSUES - BASELINE_HIGH))
          TOTAL_DELTA=$((TOTAL_ISSUES - BASELINE_TOTAL))

          echo "high_code_issues=$HIGH_ISSUES" >> $GITHUB_OUTPUT
          echo "total_code_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "high_code_issues_baseline=$BASELINE_HIGH" >> $GITHUB_OUTPUT
          echo "total_code_issues_baseline=$BASELINE_TOTAL" >> $GITHUB_OUTPUT
          echo "high_code_issues_delta=$HIGH_DELTA" >> $GITHUB_OUTPUT
          echo "total_code_issues_delta=$TOTAL_DELTA" >> $GITHUB_OUTPUT

          if [ "$HIGH_ISSUES" -gt "0" ]; then
            echo "::warning::Found $HIGH_ISSUES high severity code issues"
          fi

      - name: Run semgrep scan
        id: semgrep
        continue-on-error: true
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          generateSarif: false

      - name: Check for secrets
        id: secrets
        continue-on-error: true
        run: |
          echo "Checking for exposed secrets..."
          # Simple pattern check for common secrets
          PATTERNS="password|secret|token|api_key|private_key"

          if grep -r -i -E "($PATTERNS)\s*=\s*['\"][^'\"]{10,}" --include="*.py" --include="*.json" --include="*.yaml" --exclude-dir=.venv --exclude-dir=tests src/; then
            echo "::error::Potential secrets found in code"
            exit 3
          fi

      - name: Generate summary report
        if: always()
        run: |
          echo "# Security Audit Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Python Version**: ${{ matrix.python-version }}" >> security-summary.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-summary.md
          echo "" >> security-summary.md

          echo "## Results" >> security-summary.md
          echo "" >> security-summary.md

          # pip-audit results
          if [ -f audit-report.json ]; then
            VULN_COUNT=$(jq '.vulnerabilities | length' audit-report.json)
            echo "### Dependency Vulnerabilities (pip-audit)" >> security-summary.md
            echo "- Total vulnerabilities: $VULN_COUNT" >> security-summary.md
            echo "- Critical: ${{ steps.pip-audit.outputs.critical_count || 0 }}" >> security-summary.md
            echo "- High: ${{ steps.pip-audit.outputs.high_count || 0 }}" >> security-summary.md
            echo "" >> security-summary.md
          fi

          # Bandit results
          if [ -f bandit-report.json ]; then
            echo "### Code Security Issues (bandit)" >> security-summary.md
            TOTAL_ISSUES=$(jq '.results | length' bandit-report.json)
            echo "- Total issues: $TOTAL_ISSUES" >> security-summary.md
            echo "- High severity: ${{ steps.bandit.outputs.high_code_issues || 0 }}" >> security-summary.md
            echo "- High baseline: ${{ steps.bandit.outputs.high_code_issues_baseline || 0 }}" >> security-summary.md
            echo "- High delta: ${{ steps.bandit.outputs.high_code_issues_delta || 0 }}" >> security-summary.md
            echo "" >> security-summary.md
          fi

          # Safety results
          if [ -f safety-report.json ]; then
            echo "### Known Vulnerabilities (safety)" >> security-summary.md
            SAFETY_ISSUES=$(jq '. | length' safety-report.json 2>/dev/null || echo "0")
            echo "- Issues found: $SAFETY_ISSUES" >> security-summary.md
            echo "" >> security-summary.md
          fi

          cat security-summary.md

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ matrix.python-version }}
          path: |
            *-report.json
            security-summary.md

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let summary = 'No security summary available';

            try {
              summary = fs.readFileSync('security-summary.md', 'utf8');
            } catch (e) {
              console.log('Could not read summary:', e);
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Determine final status
        if: always()
        run: |
          # Exit codes:
          # 0 - No issues
          # 2 - General issues
          # 3 - Critical vulnerabilities or exposed secrets
          # 4 - High severity dependencies
          # 5 - Docker/container issues (not applicable here)
          # 6 - Code security issues

          if [ "${{ steps.pip-audit.outputs.critical_count }}" -gt "0" ]; then
            echo "::error::Critical vulnerabilities found"
            exit 3
          fi

          if [ "${{ steps.secrets.outcome }}" == "failure" ]; then
            echo "::error::Exposed secrets detected"
            exit 3
          fi

          if [ "${{ steps.pip-audit.outputs.high_count }}" -gt "0" ]; then
            echo "::warning::High severity dependencies found"
            exit 4
          fi

          BANDIT_HIGH_DELTA="${{ steps.bandit.outputs.high_code_issues_delta || 0 }}"
          BANDIT_HIGH_MAX_DELTA="${{ vars.SECURITY_AUDIT_BANDIT_HIGH_MAX_DELTA || 0 }}"
          if [ "$BANDIT_HIGH_DELTA" -gt "$BANDIT_HIGH_MAX_DELTA" ]; then
            echo "::warning::Code security issues above baseline delta: delta=${BANDIT_HIGH_DELTA}, max=${BANDIT_HIGH_MAX_DELTA}"
            exit 6
          fi

          if [ "${{ steps.bandit.outputs.high_code_issues || 0 }}" -gt "0" ]; then
            echo "::warning::Code security issues present but within allowed baseline delta"
          fi

          echo "::notice::Security audit passed"
          exit 0
