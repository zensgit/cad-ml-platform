name: Adaptive Rate Limit Monitor

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/api/**'
      - 'scripts/adaptive_rate_limiter.py'
      - 'scripts/rate_limit_analyzer.py'
      - 'scripts/auto_calibrator.py'
      - 'scripts/performance_monitor.py'
      - '.github/workflows/adaptive-rate-limit-monitor.yml'

  pull_request:
    branches: [main]
    paths:
      - 'src/api/**'
      - 'scripts/adaptive_rate_limiter.py'
      - 'scripts/rate_limit_analyzer.py'

  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡æ€§èƒ½åˆ†æ
    - cron: '0 * * * *'

  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'analyze'
        type: choice
        options:
          - analyze
          - calibrate
          - load-test
          - rollback

jobs:
  analyze-traffic-patterns:
    name: Analyze Traffic Patterns
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install numpy scipy

      - name: Analyze recent traffic
        id: traffic_analysis
        run: |
          python3 scripts/rate_limit_analyzer.py --export > traffic_analysis.json

          # æå–å…³é”®æŒ‡æ ‡
          pattern=$(jq -r '.pattern' traffic_analysis.json)
          confidence=$(jq -r '.confidence' traffic_analysis.json)
          anomaly_score=$(jq -r '.anomaly_score' traffic_analysis.json)

          echo "pattern=$pattern" >> $GITHUB_OUTPUT
          echo "confidence=$confidence" >> $GITHUB_OUTPUT
          echo "anomaly_score=$anomaly_score" >> $GITHUB_OUTPUT

      - name: Check for anomalies
        if: steps.traffic_analysis.outputs.anomaly_score > 0.7
        run: |
          echo "âš ï¸ æ£€æµ‹åˆ°æµé‡å¼‚å¸¸ï¼"
          echo "å¼‚å¸¸è¯„åˆ†: ${{ steps.traffic_analysis.outputs.anomaly_score }}"
          echo "æµé‡æ¨¡å¼: ${{ steps.traffic_analysis.outputs.pattern }}"

      - name: Upload traffic analysis
        uses: actions/upload-artifact@v4
        with:
          name: traffic-analysis
          path: traffic_analysis.json

  check-performance-impact:
    name: Check Performance Impact
    runs-on: ubuntu-latest
    needs: analyze-traffic-patterns

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install numpy scipy

      - name: Monitor performance impact
        id: performance
        run: |
          python3 scripts/performance_monitor.py --check-sla > sla_check.json

          # æå–SLAçŠ¶æ€
          compliance=$(jq -r '.compliance_status' sla_check.json || echo "unknown")
          violations=$(jq -r '.violations | length' sla_check.json || echo "0")

          echo "compliance=$compliance" >> $GITHUB_OUTPUT
          echo "violations=$violations" >> $GITHUB_OUTPUT

      - name: Check SLA compliance
        run: |
          if [ "${{ steps.performance.outputs.compliance }}" = "violation" ]; then
            echo "âŒ SLAè¿è§„æ£€æµ‹ï¼"
            exit 1
          elif [ "${{ steps.performance.outputs.compliance }}" = "at_risk" ]; then
            echo "âš ï¸ SLAæ¥è¿‘è¿è§„é˜ˆå€¼"
          else
            echo "âœ… SLAåˆè§„"
          fi

      - name: Generate performance report
        run: |
          python3 scripts/performance_monitor.py --export markdown > performance_report.md

          # æ·»åŠ åˆ°PRè¯„è®ºï¼ˆå¦‚æœæ˜¯PRï¼‰
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "## ğŸ“Š æ€§èƒ½å½±å“æŠ¥å‘Š" >> comment.md
            cat performance_report.md >> comment.md
          fi

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: |
            sla_check.json
            performance_report.md

  calibrate-parameters:
    name: Auto-Calibrate Parameters
    runs-on: ubuntu-latest
    needs: [analyze-traffic-patterns, check-performance-impact]
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'calibrate')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install numpy scipy

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: traffic-analysis

      - name: Run parameter calibration
        id: calibrate
        run: |
          # æ ¹æ®æµé‡åˆ†æé€‰æ‹©ä¼˜åŒ–ç›®æ ‡
          pattern=$(jq -r '.pattern' traffic_analysis.json)

          if [ "$pattern" = "spike" ]; then
            goal="throughput"
          elif [ "$pattern" = "ddos" ]; then
            goal="error_rate"
          else
            goal="balance"
          fi

          echo "ä¼˜åŒ–ç›®æ ‡: $goal"
          python3 scripts/auto_calibrator.py --goal $goal --export > calibration_result.json

          # æå–æ”¹è¿›ç™¾åˆ†æ¯”
          improvement=$(jq -r '.summary.improvement_percentage // 0' calibration_result.json)
          echo "improvement=$improvement" >> $GITHUB_OUTPUT

      - name: Create PR if improved
        if: steps.calibrate.outputs.improvement > 5
        run: |
          # åˆ›å»ºæ–°åˆ†æ”¯
          git checkout -b auto-calibration-$(date +%Y%m%d-%H%M%S)

          # åº”ç”¨æ–°é…ç½®
          cp calibration_result.json config/rate_limit_config.json

          # æäº¤æ›´æ”¹
          git add config/rate_limit_config.json
          git commit -m "feat: è‡ªåŠ¨æ ¡å‡†é™æµå‚æ•° (æ”¹è¿›${improvement}%)

          - åŸºäºæµé‡æ¨¡å¼è‡ªåŠ¨ä¼˜åŒ–
          - æ€§èƒ½æå‡: ${improvement}%
          - ä¼˜åŒ–ç›®æ ‡: $goal

          ğŸ¤– Generated by Adaptive Rate Limit Monitor"

          # åˆ›å»ºPR
          gh pr create \
            --title "è‡ªåŠ¨æ ¡å‡†é™æµå‚æ•° (æ”¹è¿›${improvement}%)" \
            --body "## ğŸ“Š å‚æ•°æ ¡å‡†ç»“æœ

            - **æ”¹è¿›**: ${improvement}%
            - **ä¼˜åŒ–ç›®æ ‡**: $goal
            - **æµé‡æ¨¡å¼**: $pattern

            è¯¦è§é™„ä»¶æŠ¥å‘Š" \
            --label "auto-calibration"

  load-test-validation:
    name: Load Test Validation
    runs-on: ubuntu-latest
    needs: calibrate-parameters
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.action == 'load-test'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install numpy scipy locust

      - name: Run A/B test
        run: |
          # è¿è¡ŒA/Bæµ‹è¯•æ¯”è¾ƒæ–°æ—§é…ç½®
          python3 scripts/auto_calibrator.py --test > ab_test_result.json

          # åˆ†æç»“æœ
          winner=$(jq -r '.winner' ab_test_result.json)
          improvement=$(jq -r '.improvement' ab_test_result.json)
          p_value=$(jq -r '.p_value' ab_test_result.json)

          echo "## A/Bæµ‹è¯•ç»“æœ" > test_report.md
          echo "- è·èƒœè€…: $winner" >> test_report.md
          echo "- æ”¹è¿›: ${improvement}%" >> test_report.md
          echo "- På€¼: $p_value" >> test_report.md

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: ab-test-results
          path: |
            ab_test_result.json
            test_report.md

  monitor-dashboard:
    name: Update Monitoring Dashboard
    runs-on: ubuntu-latest
    needs: [analyze-traffic-patterns, check-performance-impact]
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate dashboard data
        run: |
          # åˆå¹¶æ‰€æœ‰æŠ¥å‘Šæ•°æ®
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime

          dashboard = {
              "timestamp": datetime.now().isoformat(),
              "traffic": {},
              "performance": {},
              "alerts": []
          }

          # åŠ è½½æµé‡åˆ†æ
          if os.path.exists("traffic-analysis/traffic_analysis.json"):
              with open("traffic-analysis/traffic_analysis.json") as f:
                  dashboard["traffic"] = json.load(f)

          # åŠ è½½æ€§èƒ½æ•°æ®
          if os.path.exists("performance-report/sla_check.json"):
              with open("performance-report/sla_check.json") as f:
                  dashboard["performance"] = json.load(f)

          # ä¿å­˜ä»ªè¡¨æ¿æ•°æ®
          with open("dashboard.json", "w") as f:
              json.dump(dashboard, f, indent=2)

          print("Dashboard data generated")
          EOF

      - name: Update metrics in README
        run: |
          # æ›´æ–°READMEä¸­çš„ç›‘æ§æŒ‡æ ‡å¾½ç« 
          python3 << 'EOF'
          import json

          with open("dashboard.json") as f:
              data = json.load(f)

          # ç”Ÿæˆå¾½ç« URL
          sla_status = data.get("performance", {}).get("compliance_status", "unknown")
          color = "green" if sla_status == "compliant" else "red"

          badge = f"![SLA Status](https://img.shields.io/badge/SLA-{sla_status}-{color})"

          print(f"SLA Badge: {badge}")
          EOF

  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [check-performance-impact]
    if: |
      failure() ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Rollback to previous config
        run: |
          echo "âš ï¸ æ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜ï¼Œå›æ»šé…ç½®..."

          # å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šé…ç½®
          python3 scripts/auto_calibrator.py --rollback > rollback_result.json

          if [ $? -eq 0 ]; then
            echo "âœ… é…ç½®å·²å›æ»š"

            # å¤åˆ¶å›æ»šçš„é…ç½®
            cp rollback_result.json config/rate_limit_config.json

            # åˆ›å»ºå›æ»šPR
            git checkout -b emergency-rollback-$(date +%Y%m%d-%H%M%S)
            git add config/rate_limit_config.json
            git commit -m "fix: ç´§æ€¥å›æ»šé™æµé…ç½®

            æ£€æµ‹åˆ°æ€§èƒ½é€€åŒ–ï¼Œè‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šé…ç½®

            âš ï¸ Emergency rollback by monitoring system"

            gh pr create \
              --title "ç´§æ€¥: å›æ»šé™æµé…ç½®" \
              --body "æ£€æµ‹åˆ°ä¸¥é‡æ€§èƒ½é—®é¢˜ï¼Œè‡ªåŠ¨å›æ»šé…ç½®" \
              --label "emergency,rollback"
          else
            echo "âŒ å›æ»šå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¹²é¢„"
            exit 1
          fi

  post-pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [analyze-traffic-patterns, check-performance-impact]
    if: github.event_name == 'pull_request'
    permissions:
      actions: read
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Generate PR comment
        run: |
          echo "## ğŸš¦ è‡ªé€‚åº”é™æµåˆ†æ" > pr_comment.md
          echo "" >> pr_comment.md

          # æµé‡åˆ†æ
          if [ -f "traffic-analysis/traffic_analysis.json" ] && jq -e . traffic-analysis/traffic_analysis.json >/dev/null 2>&1; then
            pattern=$(jq -r '.pattern // "unknown"' traffic-analysis/traffic_analysis.json)
            confidence=$(jq -r '.confidence // "unknown"' traffic-analysis/traffic_analysis.json)
            echo "### ğŸ“Š æµé‡æ¨¡å¼" >> pr_comment.md
            echo "- **æ¨¡å¼**: $pattern" >> pr_comment.md
            echo "- **ç½®ä¿¡åº¦**: $confidence" >> pr_comment.md
            echo "" >> pr_comment.md
          else
            echo "### ğŸ“Š æµé‡æ¨¡å¼" >> pr_comment.md
            echo "- **æ¨¡å¼**: unavailable" >> pr_comment.md
            echo "- **ç½®ä¿¡åº¦**: unavailable" >> pr_comment.md
            echo "" >> pr_comment.md
          fi

          # æ€§èƒ½å½±å“
          if [ -f "performance-report/sla_check.json" ] && jq -e . performance-report/sla_check.json >/dev/null 2>&1; then
            compliance=$(jq -r '.compliance_status // "unknown"' performance-report/sla_check.json)
            echo "### ğŸ“ˆ SLAåˆè§„æ€§" >> pr_comment.md
            echo "- **çŠ¶æ€**: $compliance" >> pr_comment.md

            if [ "$compliance" != "compliant" ]; then
              echo "âš ï¸ **è­¦å‘Š**: æ­¤æ›´æ”¹å¯èƒ½å½±å“SLAåˆè§„æ€§" >> pr_comment.md
            fi
            echo "" >> pr_comment.md
          else
            echo "### ğŸ“ˆ SLAåˆè§„æ€§" >> pr_comment.md
            echo "- **çŠ¶æ€**: unavailable" >> pr_comment.md
            echo "" >> pr_comment.md
          fi

          # å»ºè®®
          echo "### ğŸ’¡ å»ºè®®" >> pr_comment.md
          echo "- ç›‘æ§éƒ¨ç½²åçš„æ€§èƒ½æŒ‡æ ‡" >> pr_comment.md
          echo "- å‡†å¤‡å¥½å›æ»šæ–¹æ¡ˆ" >> pr_comment.md
          echo "- è€ƒè™‘åœ¨ä½å³°æœŸéƒ¨ç½²" >> pr_comment.md

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-alerts:
    name: Send Alert Notifications
    runs-on: ubuntu-latest
    needs: [check-performance-impact]
    if: failure()

    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âš ï¸ é™æµç³»ç»Ÿå‘Šè­¦",
              "attachments": [{
                "color": "danger",
                "title": "æ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜",
                "text": "SLAåˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç«‹å³æŸ¥çœ‹",
                "fields": [
                  {"title": "ä»“åº“", "value": "${{ github.repository }}"},
                  {"title": "åˆ†æ”¯", "value": "${{ github.ref }}"},
                  {"title": "å·¥ä½œæµ", "value": "${{ github.workflow }}"}
                ]
              }]
            }'

      - name: Create GitHub issue
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ğŸš¨ é™æµç³»ç»Ÿæ€§èƒ½å‘Šè­¦';
            const body = `
            ## é—®é¢˜æè¿°
            è‡ªåŠ¨ç›‘æ§æ£€æµ‹åˆ°é™æµç³»ç»Ÿæ€§èƒ½é—®é¢˜

            ## è¯¦ç»†ä¿¡æ¯
            - **æ—¶é—´**: ${new Date().toISOString()}
            - **å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ## å»ºè®®æ“ä½œ
            1. æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
            2. è€ƒè™‘å›æ»šé…ç½®
            3. è°ƒæ•´é™æµå‚æ•°

            @${context.repo.owner} è¯·åŠæ—¶å¤„ç†
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['alert', 'performance', 'rate-limiting']
            });
