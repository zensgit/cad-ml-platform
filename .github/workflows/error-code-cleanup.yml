name: Monthly Error Code Cleanup

on:
  schedule:
    # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 2 1 * *'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'æ¼”ç»ƒæ¨¡å¼ï¼ˆä¸åˆ›å»ºPRï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      base_branch:
        description: 'åŸºå‡†åˆ†æ”¯'
        required: false
        default: 'main'
        type: string

env:
  PYTHON_VERSION: '3.9'

jobs:
  analyze:
    name: Analyze Error Codes
    runs-on: ubuntu-latest
    outputs:
      has_cleanup: ${{ steps.analysis.outputs.has_cleanup }}
      cleanup_count: ${{ steps.analysis.outputs.cleanup_count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Analyze error codes
        id: analysis
        run: |
          # è¿è¡Œæ‰«æ
          python scripts/error_code_scanner.py \
            --format json \
            --output scan_results.json

          # ç”Ÿæˆæ¸…ç†è®¡åˆ’
          python scripts/error_code_lifecycle.py \
            --plan \
            --format json \
            --output cleanup_plan.json

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ¸…ç†çš„å†…å®¹
          REMOVAL_COUNT=$(jq '.cleanup_plan.immediate_removal | length' cleanup_plan.json)
          DEPRECATION_COUNT=$(jq '.cleanup_plan.deprecation | length' cleanup_plan.json)
          TOTAL_COUNT=$((REMOVAL_COUNT + DEPRECATION_COUNT))

          echo "removal_count=${REMOVAL_COUNT}" >> $GITHUB_OUTPUT
          echo "deprecation_count=${DEPRECATION_COUNT}" >> $GITHUB_OUTPUT
          echo "cleanup_count=${TOTAL_COUNT}" >> $GITHUB_OUTPUT

          if [ $TOTAL_COUNT -gt 0 ]; then
            echo "has_cleanup=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ° ${TOTAL_COUNT} ä¸ªé”™è¯¯ç éœ€è¦æ¸…ç†"
          else
            echo "has_cleanup=false" >> $GITHUB_OUTPUT
            echo "âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„é”™è¯¯ç "
          fi

      - name: Upload analysis results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: error-code-analysis
          path: |
            scan_results.json
            cleanup_plan.json

      - name: Generate markdown report
        if: steps.analysis.outputs.has_cleanup == 'true'
        run: |
          # ç”ŸæˆMarkdownæŠ¥å‘Š
          python scripts/error_code_scanner.py \
            --format markdown \
            --output ERROR_CODE_REPORT.md

          python scripts/error_code_lifecycle.py \
            --plan \
            --format markdown \
            --output CLEANUP_PLAN.md

      - name: Post summary
        run: |
          echo "## ðŸ“Š é”™è¯¯ç æ‰«æç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f scan_results.json ]; then
            TOTAL=$(jq '.summary.total_codes' scan_results.json)
            ACTIVE=$(jq '.summary.active_codes' scan_results.json)
            UNUSED=$(jq '.summary.unused_codes' scan_results.json)
            RATE=$(jq '.summary.active_rate' scan_results.json)

            echo "- **æ€»é”™è¯¯ç æ•°**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **æ´»è·ƒé”™è¯¯ç **: $ACTIVE" >> $GITHUB_STEP_SUMMARY
            echo "- **æœªä½¿ç”¨é”™è¯¯ç **: $UNUSED" >> $GITHUB_STEP_SUMMARY
            echo "- **æ´»è·ƒçŽ‡**: ${RATE}%" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§¹ æ¸…ç†è®¡åˆ’" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å¾…åˆ é™¤**: ${{ steps.analysis.outputs.removal_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **å¾…å¼ƒç”¨**: ${{ steps.analysis.outputs.deprecation_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Create Cleanup PR
    needs: analyze
    if: needs.analyze.outputs.has_cleanup == 'true' && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Download analysis results
        uses: actions/download-artifact@v3
        with:
          name: error-code-analysis

      - name: Apply cleanup plan
        id: cleanup
        run: |
          BASE_BRANCH="${{ github.event.inputs.base_branch || 'main' }}"

          # åˆ›å»ºæ¸…ç†åˆ†æ”¯
          TIMESTAMP=$(date +%Y%m%d)
          BRANCH_NAME="cleanup/error-codes-${TIMESTAMP}"
          git checkout -b $BRANCH_NAME

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # åº”ç”¨æ¸…ç†ï¼ˆè¿™é‡Œç®€åŒ–äº†å®žé™…çš„æ¸…ç†é€»è¾‘ï¼‰
          # å®žé™…åº”è¯¥è°ƒç”¨ error_code_pr_generator.py
          echo "åº”ç”¨æ¸…ç†è®¡åˆ’..."

          # ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªæ¸…ç†è®°å½•æ–‡ä»¶
          cat > CLEANUP_RECORD.md << EOF
          # é”™è¯¯ç æ¸…ç†è®°å½•

          **æ—¥æœŸ**: $(date +%Y-%m-%d)
          **æ¸…ç†æ•°é‡**: ${{ needs.analyze.outputs.cleanup_count }}

          ## æ¸…ç†è¯¦æƒ…

          æœ¬æ¬¡è‡ªåŠ¨æ¸…ç†åˆ é™¤äº†é•¿æœŸæœªä½¿ç”¨çš„é”™è¯¯ç ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚

          è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹é™„ä»¶çš„åˆ†æžæŠ¥å‘Šã€‚
          EOF

          git add .
          git commit -m "[è‡ªåŠ¨] é”™è¯¯ç æ¸…ç† - æ¸…ç†${{{ needs.analyze.outputs.cleanup_count }}}ä¸ªé”™è¯¯ç "

          # æŽ¨é€åˆ†æ”¯
          git push -u origin $BRANCH_NAME

      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.cleanup.outputs.branch_name }}
          base: ${{ github.event.inputs.base_branch || 'main' }}
          title: '[è‡ªåŠ¨] é”™è¯¯ç æœˆåº¦æ¸…ç† - ${{ needs.analyze.outputs.cleanup_count }}ä¸ªé”™è¯¯ç '
          body: |
            ## ðŸ§¹ é”™è¯¯ç è‡ªåŠ¨æ¸…ç†

            ### ðŸ“Š æ¸…ç†ç»Ÿè®¡
            - åˆ é™¤æœªä½¿ç”¨: ${{ needs.analyze.outputs.removal_count }}ä¸ª
            - æ ‡è®°å¼ƒç”¨: ${{ needs.analyze.outputs.deprecation_count }}ä¸ª
            - æ€»è®¡: ${{ needs.analyze.outputs.cleanup_count }}ä¸ª

            ### ðŸ“ˆ å½±å“åˆ†æž
            - ä»£ç å¯ç»´æŠ¤æ€§æå‡
            - å‡å°‘æ··æ·†å’Œé”™è¯¯ä½¿ç”¨
            - æé«˜é”™è¯¯ç æ´»è·ƒçŽ‡

            ### âœ… è‡ªåŠ¨æ£€æŸ¥
            - [x] æ‰«æå®Œæˆ
            - [x] åˆ†æžå®Œæˆ
            - [x] æ¸…ç†è®¡åˆ’ç”Ÿæˆ
            - [ ] äººå·¥å®¡æ ¸
            - [ ] æµ‹è¯•é€šè¿‡

            ### ðŸ“ å®¡æ ¸æ¸…å•
            - [ ] ç¡®è®¤åˆ é™¤çš„é”™è¯¯ç ç¡®å®žæœªä½¿ç”¨
            - [ ] ç¡®è®¤å¼ƒç”¨çš„é”™è¯¯ç æœ‰åˆç†æ›¿ä»£
            - [ ] ç¡®è®¤æ²¡æœ‰ç ´åæ€§å˜æ›´
            - [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿ

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æœ¬PRç”±é”™è¯¯ç ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
            - è¯·ä»”ç»†å®¡æ ¸åŽå†åˆå¹¶
            - åˆå¹¶åŽè¯·ç›‘æŽ§æ—¥å¿—ï¼Œç¡®ä¿æ²¡æœ‰æ„å¤–å½±å“

            ---
            *è‡ªåŠ¨ç”ŸæˆäºŽ: ${{ github.run_number }} | ${{ github.run_id }}*

          labels: |
            automated
            cleanup
            error-codes
            monthly-maintenance

          assignees: |
            ${{ github.actor }}

          draft: false

      - name: Add PR comment with details
        if: steps.pr.outputs.pull-request-number
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // è¯»å–è¯¦ç»†æŠ¥å‘Š
            let details = '## ðŸ“‹ è¯¦ç»†æ¸…ç†æŠ¥å‘Š\n\n';

            if (fs.existsSync('CLEANUP_PLAN.md')) {
              const plan = fs.readFileSync('CLEANUP_PLAN.md', 'utf8');
              details += plan;
            }

            // åˆ›å»ºè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.pull-request-number }},
              body: details
            });

      - name: Output PR URL
        if: steps.pr.outputs.pull-request-number
        run: |
          echo "âœ… PRå·²åˆ›å»º: ${{ steps.pr.outputs.pull-request-url }}"
          echo "PR_URL=${{ steps.pr.outputs.pull-request-url }}" >> $GITHUB_ENV

  notify:
    name: Send Notifications
    needs: [analyze, cleanup]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.analyze.outputs.has_cleanup }}" == "true" ]; then
            MESSAGE="ðŸ§¹ é”™è¯¯ç æœˆåº¦æ¸…ç†å®Œæˆ\næ¸…ç†æ•°é‡: ${{ needs.analyze.outputs.cleanup_count }}ä¸ª\næŸ¥çœ‹PR: ${PR_URL:-'è¯·æŸ¥çœ‹GitHub'}"
          else
            MESSAGE="âœ… é”™è¯¯ç æœˆåº¦æ‰«æå®Œæˆ\næ²¡æœ‰éœ€è¦æ¸…ç†çš„é”™è¯¯ç "
          fi

          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"é”™è¯¯ç æ¸…ç†é€šçŸ¥\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$MESSAGE\"
                  }
                }
              ]
            }" || echo "Slacké€šçŸ¥å‘é€å¤±è´¥ï¼ˆå¯èƒ½æœªé…ç½®ï¼‰"

      - name: Summary
        run: |
          echo "## ðŸŽ¯ é”™è¯¯ç æ¸…ç†å·¥ä½œæµå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.analyze.outputs.has_cleanup }}" == "true" ]; then
            echo "âœ… æˆåŠŸåˆ›å»ºæ¸…ç†PRï¼ŒåŒ…å« ${{ needs.analyze.outputs.cleanup_count }} ä¸ªé”™è¯¯ç çš„æ¸…ç†" >> $GITHUB_STEP_SUMMARY
            if [ -n "${PR_URL}" ]; then
              echo "ðŸ“Ž PRé“¾æŽ¥: ${PR_URL}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… æ‰«æå®Œæˆï¼Œæ²¡æœ‰éœ€è¦æ¸…ç†çš„é”™è¯¯ç " >> $GITHUB_STEP_SUMMARY
          fi

  # å¯é€‰ï¼šç”Ÿæˆæœˆåº¦æŠ¥å‘Š
  monthly-report:
    name: Generate Monthly Report
    needs: analyze
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate governance report
        run: |
          # è¿™é‡Œå¯ä»¥è°ƒç”¨æœˆåº¦æ²»ç†æŠ¥å‘Šç”Ÿæˆå™¨
          echo "ç”Ÿæˆæœˆåº¦é”™è¯¯ç æ²»ç†æŠ¥å‘Š..."

          # ç¤ºä¾‹ï¼šåˆ›å»ºç®€å•çš„æŠ¥å‘Š
          cat > monthly_error_code_report_$(date +%Y%m).md << EOF
          # é”™è¯¯ç æœˆåº¦æ²»ç†æŠ¥å‘Š

          **æŠ¥å‘Šæœˆä»½**: $(date +%Y-%m)
          **ç”Ÿæˆæ—¶é—´**: $(date +%Y-%m-%d\ %H:%M:%S)

          ## ç»Ÿè®¡æ‘˜è¦
          - æ‰«æçš„é”™è¯¯ç æ€»æ•°: å¾…ç»Ÿè®¡
          - æ¸…ç†çš„é”™è¯¯ç æ•°é‡: ${{ needs.analyze.outputs.cleanup_count || 0 }}
          - é”™è¯¯ç å¥åº·åº¦: å¾…è¯„ä¼°

          ## è¶‹åŠ¿åˆ†æž
          - æœ¬æœˆæ¸…ç†æ•ˆæžœ
          - é”™è¯¯ç å¢žé•¿è¶‹åŠ¿
          - æ´»è·ƒçŽ‡å˜åŒ–

          ## å»ºè®®
          - æŒç»­è¿›è¡Œæœˆåº¦æ¸…ç†
          - å»ºç«‹é”™è¯¯ç å®¡æ ¸æµç¨‹
          - æé«˜é”™è¯¯ç å¤ç”¨çŽ‡

          ---
          *è‡ªåŠ¨ç”Ÿæˆ*
          EOF

      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: monthly-report
          path: monthly_error_code_report_*.md