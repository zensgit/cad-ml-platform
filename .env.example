# Example environment overrides for CAD ML Platform

# Server
DEBUG=true
HOST=0.0.0.0
PORT=8000
WORKERS=1
LOG_LEVEL=INFO

# CORS / Trusted hosts
CORS_ORIGINS=["*"]
ALLOWED_HOSTS=["*"]

# Redis
REDIS_ENABLED=false
REDIS_URL=redis://localhost:6379/0

# Vision Provider Configuration
# Provider selection: auto, stub, deepseek, openai, anthropic
VISION_PROVIDER=auto  # auto-detects based on available API keys

# DeepSeek Vision API (https://platform.deepseek.com)
# DEEPSEEK_API_KEY=sk-...

# OpenAI Vision API (GPT-4o) (https://platform.openai.com)
# OPENAI_API_KEY=sk-...
# OPENAI_VISION_MODEL=gpt-4o  # Options: gpt-4o, gpt-4-turbo
# OPENAI_VISION_DETAIL=high  # Options: low, high, auto

# Anthropic Vision API (Claude) (https://console.anthropic.com)
# ANTHROPIC_API_KEY=sk-ant-...
# ANTHROPIC_VISION_MODEL=claude-sonnet-4-20250514  # Or claude-3-5-sonnet-20241022

# Vision / OCR limits
# Max Base64 size for vision input (bytes). Default: 1048576 (1MB)
VISION_MAX_BASE64_BYTES=1048576
# Error rate EMA smoothing (0<alpha<=1). Higher reacts faster. Default: 0.2
ERROR_EMA_ALPHA=0.2
# OCR PDF page upper bound (override internal constant if added). Suggest <=20
OCR_MAX_PDF_PAGES=20
# OCR max file size in MB (override internal constant). Suggest <=50
OCR_MAX_FILE_MB=50

# Vector Store
VECTOR_STORE_BACKEND=memory  # Options: memory, faiss, redis

# Faiss Configuration
FAISS_INDEX_TYPE=flat  # Options: flat (brute-force), hnsw (approximate)
# HNSW parameters (only used when FAISS_INDEX_TYPE=hnsw)
FAISS_HNSW_M=32  # Graph connectivity: higher = better recall, more memory (16-64)
FAISS_HNSW_EF_CONSTRUCTION=40  # Build-time search depth: higher = better quality index (40-200)
FAISS_HNSW_EF_SEARCH=16  # Query-time search depth: higher = better recall, slower (16-256)

# 2D CAD 查重（DedupCAD-Vision + v2 JSON 精查）
# DedupCAD-Vision 服务地址（cad-ml-platform 会代理调用）
DEDUPCAD_VISION_URL=http://localhost:58001
DEDUPCAD_VISION_TIMEOUT_SECONDS=60

# DWG -> DXF conversion
DWG_CONVERTER=auto  # auto|oda|cmd|autocad|bricscad|draftsight
ODA_FILE_CONVERTER_EXE=  # auto-detects macOS default if empty
ODA_OUTPUT_VERSION=ACAD2018
DWG_TO_DXF_CMD=
DWG_AUTOCAD_CMD=
DWG_BRICSCAD_CMD=
DWG_DRAFTSIGHT_CMD=

# 2D 查重：异步后端（Phase 1/2）
# - inprocess: 进程内 job store（开发/单 worker）
# - redis: Redis + ARQ worker（推荐用于多 worker / 生产）
DEDUP2D_ASYNC_BACKEND=inprocess
DEDUP2D_ASYNC_MAX_CONCURRENCY=2
DEDUP2D_ASYNC_MAX_JOBS=200
DEDUP2D_ASYNC_TTL_SECONDS=3600
DEDUP2D_ASYNC_JOB_TIMEOUT_SECONDS=300

# 2D 查重：Redis/ARQ（Phase 2）
DEDUP2D_REDIS_URL=redis://localhost:6379/0
DEDUP2D_REDIS_KEY_PREFIX=dedup2d
DEDUP2D_ARQ_QUEUE_NAME=dedup2d:queue
DEDUP2D_WORKER_MAX_JOBS=10

# 2D 查重：上传文件存储（Phase 2.5）
# 说明：Redis job payload 不再内嵌 file_bytes，而是存储 file_ref（引用）。
# - local: 本地/共享卷（API 与 Worker 需要共享该目录）
# - s3: S3/MinIO（API 与 Worker 不需要共享磁盘；需要安装 boto3）
DEDUP2D_FILE_STORAGE=local
DEDUP2D_FILE_STORAGE_DIR=data/dedup2d_uploads
# 任务结束后是否删除上传文件（local 默认建议开启；S3 可按需）
DEDUP2D_FILE_STORAGE_CLEANUP_ON_FINISH=1
# GC 脚本保留时间（秒）。超过此时间的文件将被 GC 脚本清理。0=禁用 GC
DEDUP2D_FILE_STORAGE_RETENTION_SECONDS=3600
# S3/MinIO（backend=s3）
DEDUP2D_S3_BUCKET=
DEDUP2D_S3_PREFIX=dedup2d/uploads
DEDUP2D_S3_ENDPOINT=
DEDUP2D_S3_REGION=

# 2D 查重：滚动升级兼容（Phase 4）
# 灰度期间，可同时写入 file_ref 和 file_bytes_b64，支持尚未升级的旧 Worker。
# 升级顺序：1) 先升级 Worker 2) 待全部 Worker 升级完成后关闭此开关
# DEDUP2D_JOB_PAYLOAD_INCLUDE_BYTES_B64=0
# DEDUP2D_JOB_PAYLOAD_BYTES_B64_MAX_BYTES=10485760  # 10MB；超过此阈值不写 b64

# 2D 查重：Webhook 回调（Phase 3，可选；仅 redis backend 支持）
# callback_url 参数：见 /api/v1/dedup/2d/search?async=true&callback_url=...
DEDUP2D_CALLBACK_ALLOW_HTTP=0
DEDUP2D_CALLBACK_BLOCK_PRIVATE_NETWORKS=1
DEDUP2D_CALLBACK_RESOLVE_DNS=0
# 可选：域名白名单（逗号分隔）。配置后将只允许名单内 hostname。
DEDUP2D_CALLBACK_ALLOWLIST=
# 可选：HMAC secret。配置后会携带 X-Dedup-Signature 头用于校验回调来源。
DEDUP2D_CALLBACK_HMAC_SECRET=
DEDUP2D_CALLBACK_TIMEOUT_SECONDS=10
DEDUP2D_CALLBACK_MAX_ATTEMPTS=3
DEDUP2D_CALLBACK_BACKOFF_BASE_SECONDS=1
DEDUP2D_CALLBACK_BACKOFF_MAX_SECONDS=10

# 插件导出的 v2 JSON 存储位置（按 file_hash 落盘）
# - filesystem: 读取本地文件（默认）
# - redis: 从 Redis 读取（适合 API/Worker 不共享磁盘）
# - hybrid: 优先读本地，miss 再读 Redis
DEDUPCAD_GEOM_STORE_BACKEND=filesystem
DEDUPCAD_GEOM_STORE_DIR=data/dedup_geom
DEDUPCAD_GEOM_STORE_SUFFIX=.v2.json
# Redis geom store（backend=redis/hybrid 时）
DEDUPCAD_GEOM_STORE_REDIS_URL=redis://localhost:6379/0
DEDUPCAD_GEOM_STORE_REDIS_KEY_PREFIX=dedup2d
# 0 表示不设置 TTL（由上游生命周期管理）；>0 则自动过期
DEDUPCAD_GEOM_STORE_REDIS_TTL_SECONDS=0
# hybrid 模式可选：当从 Redis 读到后，是否回填到本地
DEDUPCAD_GEOM_STORE_HYBRID_POPULATE_LOCAL=0

# 2D 查重：租户默认阈值/预设配置（按 X-API-Key）
# 用于让客户端不必每次请求都带一堆参数（需配合 /api/v1/dedup/2d/config 管理接口）
DEDUPCAD_TENANT_CONFIG_DIR=data/dedup_tenant_configs
DEDUPCAD_TENANT_CONFIG_CACHE_TTL_SECONDS=3600
# DEDUPCAD_TENANT_CONFIG_PREFIX=dedup2d

# L4 精查：是否启用 entities_geom_hash 回退（可能提升召回，但也可能增加误报）
# 默认：unset/0（关闭）
# CAD_ML_PLATFORM_L4_ENTITIES_GEOM_HASH=1

# DWG 批处理：ODA File Converter（Windows / macOS）
# Windows:
# ODA_FILE_CONVERTER_EXE=C:\\Path\\To\\ODAFileConverter.exe
# macOS:
# ODA_FILE_CONVERTER_EXE=/Applications/ODAFileConverter.app/Contents/MacOS/ODAFileConverter
# ODA_OUTPUT_VERSION=ACAD2018

# DWG 批处理：自定义 DWG->DXF 命令模板（使用 {input} / {output}）
# DWG_TO_DXF_CMD=dwg2dxf \"{input}\" \"{output}\"

# 精查权重调参（可选；默认值在 Settings 中）
# DEDUPCAD2_W_ENTITIES=1.0
# DEDUPCAD2_W_LAYERS=0.2
# DEDUPCAD2_W_DIMENSIONS=0.5
# DEDUPCAD2_W_TEXT=0.3
# DEDUPCAD2_W_DIM_EXTRA=0.0
# DEDUPCAD2_W_HATCH_EXTRA=0.0
