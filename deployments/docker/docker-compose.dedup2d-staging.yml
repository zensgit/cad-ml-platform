# Dedup2D staging overrides (S3 + webhook callback)
# Usage:
#   docker compose -f deployments/docker/docker-compose.yml \
#     -f deployments/docker/docker-compose.minio.yml \
#     -f deployments/docker/docker-compose.dedup2d-staging.yml up -d

services:
  cad-ml-api:
    environment:
      # S3/MinIO file storage
      - DEDUP2D_FILE_STORAGE=s3
      - DEDUP2D_S3_BUCKET=${DEDUP2D_S3_BUCKET:-dedup2d-uploads}
      - DEDUP2D_S3_PREFIX=${DEDUP2D_S3_PREFIX:-uploads}
      - DEDUP2D_S3_ENDPOINT=${DEDUP2D_S3_ENDPOINT:-http://minio:9000}
      - DEDUP2D_S3_REGION=${DEDUP2D_S3_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${DEDUP2D_S3_ACCESS_KEY:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${DEDUP2D_S3_SECRET_KEY:-minioadmin}
      - DEDUP2D_FILE_STORAGE_CLEANUP_ON_FINISH=1

      # Webhook callback settings (configure in staging env/.env)
      - DEDUP2D_CALLBACK_ALLOW_HTTP=${DEDUP2D_CALLBACK_ALLOW_HTTP:-0}
      - DEDUP2D_CALLBACK_BLOCK_PRIVATE_NETWORKS=${DEDUP2D_CALLBACK_BLOCK_PRIVATE_NETWORKS:-1}
      - DEDUP2D_CALLBACK_RESOLVE_DNS=${DEDUP2D_CALLBACK_RESOLVE_DNS:-0}
      - DEDUP2D_CALLBACK_ALLOWLIST=${DEDUP2D_CALLBACK_ALLOWLIST:-}
      - DEDUP2D_CALLBACK_HMAC_SECRET=${DEDUP2D_CALLBACK_HMAC_SECRET:-}
      - DEDUP2D_CALLBACK_TIMEOUT_SECONDS=${DEDUP2D_CALLBACK_TIMEOUT_SECONDS:-10}
      - DEDUP2D_CALLBACK_MAX_ATTEMPTS=${DEDUP2D_CALLBACK_MAX_ATTEMPTS:-3}
      - DEDUP2D_CALLBACK_BACKOFF_BASE_SECONDS=${DEDUP2D_CALLBACK_BACKOFF_BASE_SECONDS:-1}
      - DEDUP2D_CALLBACK_BACKOFF_MAX_SECONDS=${DEDUP2D_CALLBACK_BACKOFF_MAX_SECONDS:-10}

  dedup2d-worker:
    environment:
      # S3/MinIO file storage (must match API)
      - DEDUP2D_FILE_STORAGE=s3
      - DEDUP2D_S3_BUCKET=${DEDUP2D_S3_BUCKET:-dedup2d-uploads}
      - DEDUP2D_S3_PREFIX=${DEDUP2D_S3_PREFIX:-uploads}
      - DEDUP2D_S3_ENDPOINT=${DEDUP2D_S3_ENDPOINT:-http://minio:9000}
      - DEDUP2D_S3_REGION=${DEDUP2D_S3_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${DEDUP2D_S3_ACCESS_KEY:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${DEDUP2D_S3_SECRET_KEY:-minioadmin}
      - DEDUP2D_FILE_STORAGE_CLEANUP_ON_FINISH=1

      # Webhook callback settings (configure in staging env/.env)
      - DEDUP2D_CALLBACK_ALLOW_HTTP=${DEDUP2D_CALLBACK_ALLOW_HTTP:-0}
      - DEDUP2D_CALLBACK_BLOCK_PRIVATE_NETWORKS=${DEDUP2D_CALLBACK_BLOCK_PRIVATE_NETWORKS:-1}
      - DEDUP2D_CALLBACK_RESOLVE_DNS=${DEDUP2D_CALLBACK_RESOLVE_DNS:-0}
      - DEDUP2D_CALLBACK_ALLOWLIST=${DEDUP2D_CALLBACK_ALLOWLIST:-}
      - DEDUP2D_CALLBACK_HMAC_SECRET=${DEDUP2D_CALLBACK_HMAC_SECRET:-}
      - DEDUP2D_CALLBACK_TIMEOUT_SECONDS=${DEDUP2D_CALLBACK_TIMEOUT_SECONDS:-10}
      - DEDUP2D_CALLBACK_MAX_ATTEMPTS=${DEDUP2D_CALLBACK_MAX_ATTEMPTS:-3}
      - DEDUP2D_CALLBACK_BACKOFF_BASE_SECONDS=${DEDUP2D_CALLBACK_BACKOFF_BASE_SECONDS:-1}
      - DEDUP2D_CALLBACK_BACKOFF_MAX_SECONDS=${DEDUP2D_CALLBACK_BACKOFF_MAX_SECONDS:-10}
