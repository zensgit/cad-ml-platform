groups:
  - name: cad_ml_degradation_alerts
    rules:
      - alert: VectorStoreDegraded
        expr: increase(similarity_degraded_total{event="degraded"}[5m]) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: Vector store degraded mode detected
          description: Faiss degraded events observed in the last 5 minutes.
      - alert: FaissRecoveryFailing
        expr: increase(faiss_recovery_attempts_total{result="error"}[10m]) > 3
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Faiss recovery attempts failing
          description: More than 3 failed recovery attempts within 10 minutes.
      - alert: DegradationFlapping
        expr: (increase(similarity_degraded_total{event="degraded"}[15m]) + increase(similarity_degraded_total{event="restored"}[15m])) > 6
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Degraded/restored flapping detected
          description: Excessive degraded/restored toggles in a short period.
      - alert: RecoveryETAStalled
        expr: (faiss_next_recovery_eta_seconds > 0) and (increase(faiss_next_recovery_eta_seconds[15m]) == 0) and (time() - process_start_time_seconds > 600)
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: Recovery ETA stalled
          description: Next recovery ETA is not advancing; investigate recovery loop.
      - alert: RecoverySuppressionSpike
        expr: increase(faiss_recovery_suppressed_total[30m]) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Recovery suppression spike
          description: Flapping suppression triggered frequently; check thresholds and backend health.
      - alert: RecoverySuppressedAttempts
        expr: increase(faiss_recovery_attempts_total{result="suppressed"}[30m]) > 5 and (time() - process_start_time_seconds > 600)
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Suppressed recovery attempts high
          description: Faiss recovery attempts are being suppressed frequently; investigate flapping or misconfiguration.
      - alert: RecoverySuppressionWindowStuck
        expr: (faiss_recovery_suppression_remaining_seconds > 0) and (increase(faiss_recovery_suppression_remaining_seconds[10m]) == 0) and (time() - process_start_time_seconds > 600)
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: Recovery suppression window stuck
          description: Suppression remaining seconds not decreasing; recovery loop may be stalled or time mocking active.

  - name: cad_ml_security_alerts
    rules:
      - alert: ModelReloadFailureSpike
        expr: increase(model_reload_total{status="error"}[10m]) > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Model reload failures spiking
          description: Model reload error count exceeded threshold in 10 minutes.
      - alert: OpcodeWhitelistViolation
        expr: increase(model_opcode_whitelist_violations_total[15m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: Opcode whitelist violation detected
          description: At least one opcode whitelist violation occurred.

  - name: cad_ml_cache_alerts
    rules:
      - alert: LowCacheHitRatio
        expr: (rate(feature_cache_hits_total[5m]) / (rate(feature_cache_hits_total[5m]) + rate(feature_cache_miss_total[5m]))) < 0.7
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Low cache hit ratio
          description: Cache hit ratio below 70% over the last 10 minutes.
      - alert: HighCacheEvictionRate
        expr: rate(feature_cache_evictions_total[5m]) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: High cache eviction rate
          description: Cache evictions per second exceed threshold.

  - name: cad_ml_feature_alerts
    rules:
      - alert: V4FeatureExtractionSlow
        expr: histogram_quantile(0.95, sum(rate(feature_extraction_latency_seconds_bucket{version="v4"}[5m])) by (le)) > 0.01
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: v4 feature extraction p95 slow
          description: p95 latency of v4 feature extraction exceeds 10ms.
      - alert: V4FeaturePerformanceDegradation
        expr: (histogram_quantile(0.95, sum(rate(feature_extraction_latency_seconds_bucket{version="v4"}[10m])) by (le)) / histogram_quantile(0.95, sum(rate(feature_extraction_latency_seconds_bucket{version="v3"}[10m])) by (le))) > 2
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: v4 performance degraded vs v3
          description: v4 p95 exceeds 2x v3 p95 over 15 minutes.

  - name: cad_ml_stress_alerts
    rules:
      - alert: HighMemoryGrowth
        expr: increase(process_resident_memory_bytes[10m]) / process_resident_memory_bytes > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: High memory growth
          description: RSS grew >50% within 10 minutes.
      - alert: ModelLoadSeqAnomaly
        expr: increase(model_health_checks_total[15m]) > 0 and increase(classification_model_load_total[15m]) == 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Model load sequence anomaly
          description: Health checks increased without corresponding model load activity.

  - name: cad_ml_migration_alerts
    rules:
      - alert: MigrationNegativeDimensionSkew
        expr: rate(vector_migrate_dimension_delta_sum[10m]) < -5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Negative dimension delta skew
          description: Sum of dimension delta indicates shrinking vectors.
      - alert: MigrationHighErrorRate
        expr: rate(vector_migrate_total{status="error"}[5m]) > 0.1
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: High migration error rate
          description: Vector migration errors exceeding acceptable rate.
