{
  "title": "CAD ML Observability",
  "panels": [
    {
      "type": "graph",
      "title": "Degraded/Restored Events",
      "targets": [
        {
          "expr": "sum(increase(similarity_degraded_total{event=\"degraded\"}[15m]))"
        },
        {
          "expr": "sum(increase(similarity_degraded_total{event=\"restored\"}[15m]))"
        }
      ],
      "description": "Monitor degraded/restored toggles (flapping risk)"
    },
    {
      "type": "gauge",
      "title": "Faiss Next Recovery ETA (s)",
      "targets": [
        {
          "expr": "faiss_next_recovery_eta_seconds"
        }
      ],
      "description": "0 = healthy or no scheduled attempt"
    },
    {
      "type": "graph",
      "title": "Faiss Recovery Attempts",
      "targets": [
        {
          "expr": "sum(rate(faiss_recovery_attempts_total{result=\"success\"}[5m]))"
        },
        {
          "expr": "sum(rate(faiss_recovery_attempts_total{result=\"error\"}[5m]))"
        }
      ],
      "description": "Compare success vs error recovery rates"
    },
    {
      "type": "stat",
      "title": "Recovery Suppression Count",
      "targets": [
        {
          "expr": "sum(faiss_recovery_suppressed_total)"
        }
      ]
    },
    {
      "type": "graph",
      "title": "Faiss Degraded Duration (s)",
      "targets": [
        {
          "expr": "faiss_degraded_duration_seconds"
        }
      ],
      "description": "Duration resets to 0 when restored"
    },
    {
      "type": "stat",
      "title": "Recovery Suppression Total",
      "targets": [
        {
          "expr": "sum(faiss_recovery_suppressed_total)"
        }
      ]
    },
    {
      "type": "graph",
      "title": "v4 Feature Extraction p95 (s)",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(feature_extraction_latency_seconds_bucket{version=\"v4\"}[5m])) by (le))"
        }
      ],
      "description": "Latency objective p95 <= 10ms and <=2x v3"
    },
    {
      "type": "graph",
      "title": "Vector Migrate Dimension Delta",
      "targets": [
        {
          "expr": "sum(rate(vector_migrate_dimension_delta_bucket[5m])) by (le)"
        }
      ],
      "description": "Histogram of dimension change deltas"
    },
    {
      "type": "graph",
      "title": "Opcode Audit/Violations",
      "targets": [
        {
          "expr": "sum(rate(model_opcode_audit_total[5m]))"
        },
        {
          "expr": "sum(rate(model_opcode_whitelist_violations_total[5m]))"
        }
      ],
      "description": "Monitor opcode security during model reload"
    },
    {
      "type": "graph",
      "title": "Cache Hit/Miss",
      "targets": [
        {
          "expr": "rate(feature_cache_hits_total[5m])"
        },
        {
          "expr": "rate(feature_cache_miss_total[5m])"
        }
      ],
      "description": "Hit ratio goal >=85% post tuning"
    },
    {
      "type": "stat",
      "title": "Recovery State Backend",
      "targets": [
        {
          "expr": "sum by (backend)(faiss_recovery_state_backend)"
        }
      ]
    },
    {
      "title": "Faiss Suppression Remaining",
      "type": "graph",
      "targets": [
        {
          "expr": "faiss_recovery_suppression_remaining_seconds"
        }
      ]
    }
  ]
}
