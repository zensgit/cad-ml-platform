# CAD ML Platform - 优化与演进路线图 (Optimization Roadmap)

> **最后更新**: 2025-12-08
> **版本**: v1.0.0
> **状态**: 规划中

本文档基于对现有代码库的深入分析，结合业务需求与技术现状，制定了 CAD ML Platform 的优化与演进路线图。

---

## 📊 现状分析 (Current State)

| 模块 | 当前实现 | 局限性 |
|------|---------|--------|
| **特征提取** | v1-v4 (统计特征: 实体数, 包围盒, 表面数) | 缺乏拓扑结构与视觉语义，难以区分复杂异形件 |
| **向量检索** | Faiss `IndexFlatIP` (暴力搜索) | O(n) 复杂度，无法支撑 10k+ 规模的高频检索 |
| **零件分类** | 启发式规则 (`if entity < 20...`) | 规则脆弱，无法泛化，难以维护 |
| **批量处理** | 串行循环 (`for file in files`) | 无法利用多核/多节点优势，吞吐量低 |
| **Vision/OCR** | Stub (占位符) / 通用 OCR | 缺乏真实视觉理解能力，特殊符号识别率低 |
| **工艺推荐** | 静态 YAML 映射表 | 无法处理几何约束（如倒扣、壁厚），缺乏柔性 |

---

## 🚀 演进路线图 (Roadmap)

### Phase 1: 核心智能升级 (Core Intelligence Upgrade) - Q1 2026
> **目标**: 替换规则引擎，引入真正的机器学习与高效索引，解决“准”和“快”的问题。

#### 1.1 机器学习分类器落地 (ML Classifier)
*   **现状**: `src/core/analyzer.py` 使用硬编码规则。
*   **行动**:
    *   数据准备: 收集并标注 5000+ 真实 CAD 图纸数据。
    *   模型训练: 训练 **XGBoost** 或 **Random Forest** 分类器 (输入: v4 特征向量)。
    *   集成: 完善 `src/ml/classifier.py`，实现模型文件的自动加载、版本校验与推理。
    *   **预期收益**: 分类准确率从 <70% 提升至 90%+，支持 20+ 种零件类型。

#### 1.2 向量索引升级 (Vector Index Optimization)
*   **现状**: `IndexFlatIP` (暴力计算)。
*   **行动**:
    *   引入 **Faiss HNSW (Hierarchical Navigable Small World)** 索引。
    *   实现索引的构建、序列化与增量更新机制。
    *   优化 `src/core/similarity.py`，支持索引参数配置（如 `M`, `efConstruction`）。
    *   **预期收益**: 检索速度提升 10-50 倍，支持百万级向量毫秒级响应。

#### 1.3 真实 Vision 能力接入 (Real Vision Integration)
*   **现状**: `DeepSeekStubProvider` 返回固定文本。
*   **行动**:
    *   对接 **GPT-4o** 或 **Claude 3.5 Sonnet** API (或私有化部署 LLaVA/Qwen-VL)。
    *   实现 Prompt Engineering，专门针对工程图纸优化（关注标题栏、BOM、技术要求）。
    *   **预期收益**: 实现真正的“图纸语义理解”，支持自然语言问答。

---

### Phase 2: 深度特征与知识融合 (Deep Features & Knowledge) - Q2 2026
> **目标**: 引入深度学习特征与专家知识，解决“深”的问题。

#### 2.1 特征提取 v5 (Advanced Features)
*   **行动**:
    *   **拓扑特征**: 计算 Betti numbers (孔洞数、连通分量)，区分拓扑结构。
    *   **视觉特征**: 生成多视图缩略图，使用轻量级 CNN (如 MobileNet) 提取视觉嵌入。
    *   **矩不变量**: 计算 Hu Moments，增强旋转不变性。
    *   **预期收益**: 大幅提升对“形状相似但拓扑不同”零件的区分能力。

#### 2.2 知识库与推理引擎 (Knowledge Reasoning)
*   **现状**: 静态 YAML 规则。
*   **行动**:
    *   构建 **MaterialKnowledgeBase** (材料属性库) 与 **ManufacturingKnowledgeBase** (制造约束库)。
    *   引入轻量级规则引擎，支持复杂逻辑 (e.g., "若壁厚<2mm且材料为铸铁，则不可铸造")。
    *   **预期收益**: 工艺推荐准确率与实用性大幅提升。

#### 2.3 批量处理并发优化 (Batch Concurrency)
*   **现状**: `/batch` 接口串行处理。
*   **行动**:
    *   重构 `batch_analyze`，使用 `asyncio.gather` 实现进程内并发。
    *   引入 **Celery + Redis** 任务队列，支持跨节点的分布式批量处理。
    *   **预期收益**: 批量吞吐量提升 5-10 倍。

---

### Phase 3: 闭环与自适应 (Loop & Adaptive) - Q3 2026
> **目标**: 建立数据闭环，实现系统的自我进化。

#### 3.1 主动学习 (Active Learning)
*   **行动**:
    *   构建“置信度筛选”机制：自动捕获低置信度样本。
    *   开发标注界面，允许专家修正分类结果。
    *   实现模型自动重训练 (Retrain) 与热更新流水线。
    *   **预期收益**: 模型性能随使用时间自动提升，减少人工维护成本。

#### 3.2 度量学习 (Metric Learning)
*   **行动**:
    *   收集“相似/不相似”样本对。
    *   训练 **Siamese Network (孪生网络)**，学习专用的距离度量空间。
    *   **预期收益**: 相似度检索更符合人类工程师的直觉（功能相似优先于形状相似）。

---

## 📉 性能优化专项 (Performance Tuning)

| 优化项 | 当前状态 | 目标状态 | 技术手段 |
|--------|---------|----------|----------|
| **向量过滤** | Post-filtering (Python层) | Pre-filtering (索引层) | 利用 Faiss `IDSelector` 或构建分库索引 |
| **特征缓存** | 内存/Redis (已实现) | 持久化 + 跨版本复用 | 优化 Cache Key 策略，支持部分特征复用 |
| **冷启动** | 模型加载慢 | 秒级启动 | 模型量化 (Quantization)、懒加载 (Lazy Loading) |
| **内存占用** | 随向量数线性增长 | 常数级/可控 | 向量量化 (PQ, Product Quantization) |

---

## 📝 附录：优先级矩阵

| 优先级 | 任务 | 复杂度 | 收益 | 备注 |
|:---:|---|:---:|:---:|---|
| **P0** | **ML 分类器落地** | 中 | 高 | 核心智能基石 |
| **P0** | **Faiss HNSW 索引** | 中 | 高 | 解决规模化瓶颈 |
| **P0** | **真实 Vision 接入** | 低 | 高 | 开启多模态能力 |
| **P1** | **批量接口并发优化** | 低 | 中 | 提升吞吐量 |
| **P1** | **特征提取 v5** | 高 | 中 | 解决长尾识别问题 |
| **P2** | **知识库融合** | 高 | 中 | 提升专家系统能力 |
| **P2** | **主动学习流水线** | 高 | 高 | 长期维护关键 |
