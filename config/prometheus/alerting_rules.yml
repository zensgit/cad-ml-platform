groups:
  - name: cad_ml_platform_alerts
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: platform_error_ratio > 5
        for: 5m
        labels:
          severity: critical
          component: platform
        annotations:
          summary: "High error rate detected ({{ $value | humanizePercentage }})"
          description: "Platform error rate is {{ $value | humanizePercentage }} over the last 5 minutes"
          runbook_url: "https://docs.example.com/runbooks/high-error-rate"

      # Provider Down Alert
      - alert: ProviderDown
        expr: provider_health_score < 50
        for: 10m
        labels:
          severity: warning
          component: ocr
          provider: "{{ $labels.provider }}"
        annotations:
          summary: "Provider {{ $labels.provider }} health degraded"
          description: "Provider {{ $labels.provider }} health score is {{ $value }}%"
          runbook_url: "https://docs.example.com/runbooks/provider_down"

      # Provider Timeout Alert
      - alert: ProviderTimeout
        expr: rate(ocr_errors_total{code="PROVIDER_TIMEOUT"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: ocr
          provider: "{{ $labels.provider }}"
        annotations:
          summary: "Provider {{ $labels.provider }} experiencing timeouts"
          description: "Provider {{ $labels.provider }} timeout rate is {{ $value }} per second"
          runbook_url: "https://docs.example.com/runbooks/provider_timeout.md"

      # Model Load Error Alert
      - alert: ModelLoadError
        expr: sum(rate(ocr_errors_total{code="MODEL_LOAD_ERROR"}[5m])) > 0
        for: 2m
        labels:
          severity: critical
          component: model
        annotations:
          summary: "Model loading failures detected"
          description: "{{ $value }} model load errors per second"
          runbook_url: "https://docs.example.com/runbooks/model_load_error.md"

      # Resource Exhaustion Alert
      - alert: ResourceExhaustion
        expr: rate(ocr_errors_total{code="RESOURCE_EXHAUSTED"}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          component: resources
        annotations:
          summary: "Resource exhaustion detected"
          description: "Resource exhaustion errors at {{ $value }} per second"
          action: "Scale up pods or increase resource limits"

      # SLO Violation Alert
      - alert: SLOViolation
        expr: slo_availability < 99.5
        for: 10m
        labels:
          severity: warning
          component: slo
        annotations:
          summary: "SLO availability below target"
          description: "Current availability is {{ $value }}%, target is 99.5%"
          dashboard: "https://grafana.example.com/d/observability"

      # Error Budget Exhaustion Alert
      - alert: ErrorBudgetCritical
        expr: error_budget_remaining < 20
        for: 5m
        labels:
          severity: critical
          component: slo
        annotations:
          summary: "Error budget critically low"
          description: "Only {{ $value }}% of error budget remaining"
          action: "Freeze deployments and investigate issues"

      # High Latency Alert
      - alert: HighLatency
        expr: ocr_p95_latency_seconds > 2
        for: 10m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "High latency detected"
          description: "P95 latency is {{ $value }}s (threshold: 2s)"
          dashboard: "https://grafana.example.com/d/performance"

      # Input Rejection Spike Alert
      - alert: InputRejectionSpike
        expr: rate(ocr_input_rejected_total[5m]) > 1
        for: 5m
        labels:
          severity: info
          component: validation
        annotations:
          summary: "High input rejection rate"
          description: "Input rejection rate is {{ $value }} per second for reason: {{ $labels.reason }}"

      # Cache Hit Rate Drop Alert
      - alert: CacheHitRateLow
        expr: |
          (
            sum(rate(analysis_cache_hits_total[5m])) / (sum(rate(analysis_cache_hits_total[5m])) + sum(rate(analysis_cache_miss_total[5m])))
          ) < 0.3
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Analysis cache hit rate low (<30%)"
          description: "Hit rate is {{ $value | humanizePercentage }} over last 5m"
          runbook_url: "https://docs.example.com/runbooks/cache_hit_rate_low"
          feature_version: "${FEATURE_VERSION}"  # annotate current feature version for correlation

      # Feature Cache Sliding Hour Hit Rate Drop Alert
      - alert: FeatureCacheHitRateLowSlidingHour
        expr: |
          (
            feature_cache_hits_last_hour / (feature_cache_hits_last_hour + feature_cache_miss_last_hour)
          ) < 0.3 and (feature_cache_hits_last_hour + feature_cache_miss_last_hour) > 25
        for: 15m
        labels:
          severity: warning
          component: feature_cache
        annotations:
          summary: "Feature cache sliding hour hit rate low (<30%)"
          description: "Hit rate below 30% in last hour window (hits={{ $value }})"
          runbook_url: "docs/runbooks/cache_hit_rate_low.md"

      # Drift Baseline Stale Alert
      - alert: DriftBaselineStale
        expr: |
          max(baseline_material_age_seconds) > bool max_over_time(baseline_material_age_seconds[1m]) * on() DRIFT_BASELINE_MAX_AGE_SECONDS OR max(baseline_prediction_age_seconds) > bool max_over_time(baseline_prediction_age_seconds[1m]) * on() DRIFT_BASELINE_MAX_AGE_SECONDS
        for: 30m
        labels:
          severity: warning
          component: drift
        annotations:
          summary: "Drift baseline stale (age exceeds max)"
          description: "Material or prediction baseline age exceeded max age setting"
          runbook_url: "https://docs.example.com/runbooks/drift_baseline_stale"
      - alert: FaissIndexStale
        expr: faiss_index_age_seconds > 3600
        for: 10m
        labels:
          severity: warning
          component: cad_analysis
        annotations:
          summary: "Faiss index stale (>1h without refresh)"
          description: "Faiss index age {{ $value }}s (>3600s)"
          action: "Trigger manual export/import or rebuild"
          runbook_url: "docs/runbooks/faiss_index_stale.md"

      # Material Distribution Drift Alert
      - alert: MaterialDistributionDrift
        expr: |
          max_over_time(material_drift_ratio[30m]) > 0.85
        for: 15m
        labels:
          severity: warning
          component: cad-analysis
        annotations:
          summary: "Material distribution drift (dominant >85%)"
          description: "Dominant material ratio {{ $value }} over last 30m indicates potential data imbalance"
          runbook_url: "https://docs.example.com/runbooks/material_distribution_drift"

      - alert: ClassificationPredictionDrift
        expr: |
          (
            sum(rate(classification_prediction_distribution[30m])) by (label)
            / ignoring(label)
            sum(rate(classification_prediction_distribution[30m]))
          ) > 0.85
        for: 15m
        labels:
          severity: warning
          component: classification
        annotations:
          summary: "Classification prediction drift (single label >85%)"
          description: "Label {{ $labels.label }} accounts for >85% of predictions over 30m"
          runbook_url: "https://docs.example.com/runbooks/classification_prediction_drift"

      # No Data Alert
      - alert: NoMetricsData
        expr: up{job="cad-ml-platform"} == 0
        for: 5m
        labels:
          severity: critical
          component: monitoring
        annotations:
          summary: "No metrics data from CAD ML Platform"
          description: "Prometheus cannot scrape metrics from the application"
          action: "Check application health and network connectivity"

  - name: infrastructure_alerts
    interval: 30s
    rules:
      # High CPU Usage
      - alert: HighCPUUsage
        expr: |
          (
            100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          ) > 80
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% on instance {{ $labels.instance }}"

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          (
            1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
          ) * 100 > 85
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}% on instance {{ $labels.instance }}"

      # Disk Space Alert
      - alert: DiskSpaceLow
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}
          ) * 100 < 20
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Only {{ $value }}% disk space remaining on {{ $labels.instance }}"

      # Pod Restart Alert
      - alert: PodRestartingTooOften
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: kubernetes
        annotations:
          summary: "Pod {{ $labels.pod }} restarting frequently"
          description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in 15 minutes"

  - name: business_alerts
    interval: 1m
    rules:
      # Low Confidence Score Alert
      - alert: LowConfidenceScore
        expr: ocr_avg_confidence < 0.7
        for: 15m
        labels:
          severity: info
          component: quality
        annotations:
          summary: "OCR confidence score below threshold"
          description: "Average OCR confidence is {{ $value }} (threshold: 0.7)"
          impact: "Results may be unreliable"

      # Circuit Breaker Open
      - alert: CircuitBreakerOpen
        expr: circuit_breaker_open_ratio > 0.5
        for: 5m
        labels:
          severity: critical
          component: resilience
        annotations:
          summary: "Multiple circuit breakers open"
          description: "{{ $value | humanizePercentage }} of circuit breakers are open"
          action: "Investigate provider failures immediately"

      # Throughput Drop
      - alert: ThroughputDrop
        expr: |
          (
            rate(ocr_requests_total[5m]) <
            (avg_over_time(rate(ocr_requests_total[5m])[1h:5m]) * 0.5)
          )
        for: 10m
        labels:
          severity: warning
          component: business
        annotations:
          summary: "Significant throughput drop detected"
          description: "Current throughput is 50% below hourly average"
      - alert: CadAnalysisLowSuccessRate
        expr: (sum(rate(analysis_requests_total{status="success"}[5m])) / sum(rate(analysis_requests_total[5m]))) * 100 < 90
        for: 5m
        labels:
          severity: warning
          component: cad_analysis
        annotations:
          summary: "CAD analysis success rate below 90%"
          description: "Success rate is {{ $value }}% (<90%) over last 5m"
          action: "Check recent error codes and service logs"
          runbook: "docs/runbooks/cad_analysis_low_success_rate.md"

      - alert: CadAnalysisHighInternalErrors
        expr: rate(analysis_error_code_total{code="INTERNAL_ERROR"}[5m]) > 0.2
        for: 5m
        labels:
          severity: critical
          component: cad_analysis
        annotations:
          summary: "Spike in INTERNAL_ERROR codes"
          description: "INTERNAL_ERROR rate {{ $value }} per second (>0.2)"
          action: "Inspect stack traces and recent deployments"
          runbook: "docs/runbooks/cad_analysis_internal_errors.md"

      - alert: CadAnalysisStageLatencyParseP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(analysis_stage_duration_seconds_bucket{stage="parse"}[5m]))) > 0.5
        for: 10m
        labels:
          severity: warning
          component: cad_analysis
        annotations:
          summary: "Parse stage p95 latency >500ms"
          description: "Parse p95 {{ $value }}s (>0.5s)"
          action: "Check adapter performance and input sizes"
          runbook: "docs/runbooks/cad_analysis_parse_latency.md"

      - alert: CadAnalysisEntityRejectionSpike
        expr: increase(analysis_rejections_total{reason="entity_count_exceeded"}[10m]) > 50
        for: 10m
        labels:
          severity: info
          component: cad_analysis
        annotations:
          summary: "Entity rejection spike"
          description: "{{ $value }} rejections in last 10m (reason: entity_count_exceeded)"
          action: "Review ANALYSIS_MAX_ENTITIES and incoming traffic pattern"
          runbook: "docs/runbooks/cad_analysis_rejection_spike.md"

      - alert: CadAnalysisMaterialImbalance
        expr: |
          stddev_over_time(sum by (material) (rate(analysis_material_usage_total[5m]))[30m]) > 5
        for: 30m
        labels:
          severity: info
          component: cad_analysis
        annotations:
          summary: "Material usage distribution shifting"
          description: "High stddev in material usage over last 30m"
          action: "Validate input tagging and potential skew"

  # ==================== Day 3-4 Feature Alerts ====================
  - name: v4_feature_alerts
    interval: 30s
    rules:
      # V4 Feature Extraction Slowdown Alert
      - alert: FeatureExtractionV4SlowDown
        expr: |
          (
            histogram_quantile(0.95, sum by (le) (rate(feature_extraction_latency_seconds_bucket{version="v4"}[5m])))
            >
            histogram_quantile(0.95, sum by (le) (rate(feature_extraction_latency_seconds_bucket{version="v3"}[5m]))) * 1.5
          )
          and
          histogram_quantile(0.95, sum by (le) (rate(feature_extraction_latency_seconds_bucket{version="v4"}[5m]))) > 0
        for: 10m
        labels:
          severity: warning
          component: feature_extraction
        annotations:
          summary: "V4 feature extraction p95 latency exceeds V3 by >50%"
          description: "V4 p95 latency is more than 1.5x V3 p95 over last 10 minutes"
          action: "Review V4 shape_entropy and surface_count computation overhead"
          runbook_url: "docs/runbooks/v4_feature_slowdown.md"

      # V4 Absolute Latency High
      - alert: FeatureExtractionV4LatencyHigh
        expr: |
          histogram_quantile(0.95, sum by (le) (rate(feature_extraction_latency_seconds_bucket{version="v4"}[5m]))) > 0.010
        for: 5m
        labels:
          severity: warning
          component: feature_extraction
        annotations:
          summary: "V4 feature extraction p95 latency >10ms"
          description: "V4 p95 latency is {{ $value }}s (>10ms threshold)"
          action: "Check entity count in documents and optimize compute functions"
          runbook_url: "docs/runbooks/v4_feature_latency.md"

      # Shape Entropy Computation Anomaly
      - alert: ShapeEntropyComputationAnomaly
        expr: |
          rate(feature_extraction_errors_total{step="shape_entropy"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: feature_extraction
        annotations:
          summary: "Shape entropy computation errors detected"
          description: "{{ $value }} shape entropy errors per second"
          action: "Check entity type distributions and log edge cases"

  - name: model_security_alerts
    interval: 30s
    rules:
      # Model Opcode Blocked Alert (Day 4 Security)
      - alert: ModelOpcodeBlocked
        expr: |
          increase(model_security_fail_total{reason="opcode_blocked"}[5m]) > 0
        labels:
          severity: critical
          component: model_security
        annotations:
          summary: "Model security: Dangerous opcode detected and blocked"
          description: "{{ $value }} opcode violations in last 5 minutes"
          action: "Investigate model source and quarantine suspicious files"
          runbook_url: "docs/runbooks/model_opcode_blocked.md"

      # Model Security Validation Failures
      - alert: ModelSecurityValidationFailure
        expr: |
          rate(model_security_fail_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: model_security
        annotations:
          summary: "Model security validation failures detected"
          description: "{{ $value }} security validation failures per second"
          action: "Review model sources and validation logs"
          runbook_url: "docs/runbooks/model_security_validation.md"

      # Interface Validation Failure Spike
      - alert: ModelInterfaceValidationFailure
        expr: |
          increase(model_interface_validation_failures_total[10m]) > 5
        for: 5m
        labels:
          severity: warning
          component: model_interface
        annotations:
          summary: "Model interface validation failures detected"
          description: "{{ $value }} interface validation failures in last 10 minutes"
          action: "Check model compatibility and version alignment"
          runbook_url: "docs/runbooks/model_interface_validation.md"

      # Pickle Scanner High Risk Detection
      - alert: PickleScannerHighRisk
        expr: |
          increase(pickle_scanner_high_risk_total[5m]) > 0
        labels:
          severity: critical
          component: model_security
        annotations:
          summary: "High-risk pickle content detected"
          description: "Scanner detected {{ $value }} high-risk pickle operations"
          action: "IMMEDIATE: Quarantine model and investigate source"
          runbook_url: "docs/runbooks/pickle_scanner_high_risk.md"

  - name: rollback_alerts
    interval: 30s
    rules:
      # Model Rollback Triggered
      - alert: ModelRollbackTriggered
        expr: |
          increase(model_rollback_events_total[5m]) > 0
        labels:
          severity: warning
          component: model_rollback
        annotations:
          summary: "Model rollback event triggered"
          description: "{{ $value }} rollback events in last 5 minutes"
          action: "Review rollback reason and model performance metrics"
          runbook_url: "docs/runbooks/model_rollback.md"

      # Rollback Level Critical (Level 3)
      - alert: RollbackLevelCritical
        expr: |
          model_rollback_level >= 3
        for: 5m
        labels:
          severity: critical
          component: model_rollback
        annotations:
          summary: "Model rollback at critical level (Level 3)"
          description: "System has rolled back to fallback model (level {{ $value }})"
          action: "URGENT: Investigate model failures and restore primary model"
          runbook_url: "docs/runbooks/rollback_level_critical.md"

      # No Snapshots Available
      - alert: NoRollbackSnapshotsAvailable
        expr: |
          model_available_snapshots < 1
        for: 10m
        labels:
          severity: warning
          component: model_rollback
        annotations:
          summary: "No rollback snapshots available"
          description: "No model snapshots available for rollback"
          action: "Create model snapshots to enable rollback capability"
          runbook_url: "docs/runbooks/no_rollback_snapshots.md"

  - name: drift_detection_alerts
    interval: 1m
    rules:
      # Drift Refresh Triggered
      - alert: DriftRefreshTriggered
        expr: |
          increase(drift_refresh_triggers_total[30m]) > 3
        for: 15m
        labels:
          severity: info
          component: drift_detection
        annotations:
          summary: "Multiple drift refresh triggers detected"
          description: "{{ $value }} drift refreshes in last 30 minutes"
          action: "Review data distribution changes and baseline settings"

      # Drift Score High
      - alert: DriftScoreHigh
        expr: |
          drift_score > 0.3
        for: 30m
        labels:
          severity: warning
          component: drift_detection
        annotations:
          summary: "High drift score detected"
          description: "Drift score is {{ $value }} (>0.3 threshold)"
          action: "Consider baseline refresh or model retraining"
          runbook_url: "docs/runbooks/drift_score_high.md"

      # Baseline Age Critical
      - alert: BaselineAgeCritical
        expr: |
          max(baseline_material_age_seconds, baseline_prediction_age_seconds) > 604800
        for: 1h
        labels:
          severity: warning
          component: drift_detection
        annotations:
          summary: "Drift baseline is older than 7 days"
          description: "Baseline age is {{ $value }}s (>7 days)"
          action: "Schedule baseline refresh to maintain drift detection accuracy"

  - name: cache_tuning_alerts
    interval: 1m
    rules:
      # Cache Hit Rate Low (Using Recording Rule)
      - alert: FeatureCacheHitRateLowRecorded
        expr: |
          cad:feature_cache_hit_rate:1h < 0.35
        for: 30m
        labels:
          severity: warning
          component: cache_tuning
        annotations:
          summary: "Feature cache hit rate below 35% (1h window)"
          description: "Hit rate is {{ $value | humanizePercentage }} over last hour"
          action: "Review cache TTL settings and access patterns"
          runbook_url: "docs/runbooks/cache_hit_rate_low.md"

      # Cache Tuning Recommendation Generated
      - alert: CacheTuningRecommendationPending
        expr: |
          cache_tuning_recommendations_pending > 0
        for: 1h
        labels:
          severity: info
          component: cache_tuning
        annotations:
          summary: "Cache tuning recommendations available"
          description: "{{ $value }} cache tuning recommendations pending review"
          action: "Review and apply recommended cache settings"

      # Memory Fallback Active
      - alert: MemoryFallbackActive
        expr: |
          cad:memory_fallback_ratio:5m > 0.1
        for: 10m
        labels:
          severity: warning
          component: vector_store
        annotations:
          summary: "Memory fallback mode active (>10% of queries)"
          description: "{{ $value | humanizePercentage }} of queries using memory fallback"
          action: "Check Faiss index health and consider rebuild"
          runbook_url: "docs/runbooks/memory_fallback_active.md"

  - name: vector_migration_alerts
    interval: 30s
    rules:
      # V4 Adoption Rate Low
      - alert: V4AdoptionRateLow
        expr: |
          (
            sum(rate(vector_migrate_total{to_version="v4"}[1h]))
            /
            sum(rate(vector_migrate_total[1h]))
          ) < 0.5
          and
          sum(rate(vector_migrate_total[1h])) > 10
        for: 1h
        labels:
          severity: info
          component: vector_migration
        annotations:
          summary: "V4 adoption rate below 50%"
          description: "Only {{ $value | humanizePercentage }} of migrations going to V4"
          action: "Review migration strategy and V4 benefits communication"

      # High Downgrade Rate
      - alert: VectorDowngradeRateHigh
        expr: |
          (
            sum(rate(vector_migrate_total{status="downgraded"}[1h]))
            /
            sum(rate(vector_migrate_total[1h]))
          ) > 0.1
          and
          sum(rate(vector_migrate_total[1h])) > 5
        for: 30m
        labels:
          severity: warning
          component: vector_migration
        annotations:
          summary: "Vector downgrade rate above 10%"
          description: "{{ $value | humanizePercentage }} of migrations are downgrades"
          action: "Investigate compatibility issues and client version distribution"
          runbook_url: "docs/runbooks/vector_downgrade_high.md"

      # Migration Error Rate High
      - alert: VectorMigrationErrorRateHigh
        expr: |
          (
            sum(rate(vector_migrate_total{status="error"}[30m]))
            /
            sum(rate(vector_migrate_total[30m]))
          ) > 0.05
          and
          sum(rate(vector_migrate_total[30m])) > 5
        for: 15m
        labels:
          severity: warning
          component: vector_migration
        annotations:
          summary: "Vector migration error rate above 5%"
          description: "{{ $value | humanizePercentage }} of migrations failing"
          action: "Check migration logs and vector compatibility"
          runbook_url: "docs/runbooks/vector_migration_errors.md"
