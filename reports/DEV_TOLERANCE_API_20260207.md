# DEV_TOLERANCE_API_20260207

## Goal

Expose a minimal, testable API loop for "公差知识" (ISO 286 / GB/T 1800):

- Query IT tolerance value by nominal size + grade
- Query limit deviations (EI/ES, ei/es) by symbol + grade + nominal size
- Query common fit deviations and clearance range by fit code + nominal size

This enables downstream automation (rules/assistant/validation) without manual PDF lookups.

## Changes

### 1) New API router

- Added `src/api/v1/tolerance.py`:
  - `GET /api/v1/tolerance/it`
    - Params: `diameter_mm`, `grade` (e.g., `IT7`)
    - Returns: `tolerance_um`
  - `GET /api/v1/tolerance/limit-deviations`
    - Params: `symbol` (e.g., `H`, `h`, `g`, `JS`), `grade` (e.g., `7`), `diameter_mm`
    - Returns: `lower_deviation_um`, `upper_deviation_um`
  - `GET /api/v1/tolerance/fit`
    - Params: `fit_code` (e.g., `H7/g6`), `diameter_mm`
    - Returns: hole/shaft deviations, `min_clearance_um`, `max_clearance_um`, `fit_type`
    - Includes best-effort normalization for inputs like `h7/G6` -> `H7/g6`.

### 2) Router registration

- Updated `src/api/__init__.py` to mount the new router:
  - Prefix: `/api/v1/tolerance`
  - Tags: `公差`

### 3) Tests

- Added `tests/integration/test_tolerance_api.py`:
  - `IT7 @ 25mm -> 21um`
  - `H7 @ 25mm -> (0, 21)um`
  - `H7/g6 @ 25mm -> clearance range [7, 41]um` (also verifies fit-code normalization)

## Verification

Ran:

```bash
.venv/bin/pytest -q tests/integration/test_tolerance_api.py
```

Result:

- `3 passed`

## Notes / Limits

- Limit deviation table data is loaded from `data/knowledge/iso286_deviations.json` (generated by `scripts/extract_iso286_deviations.py`).
- Fit deviations are computed from IT grades + fundamental deviation tables; common fits are defined in `src/core/knowledge/tolerance/fits.py`.

