# EdgeGraphSage 训练实验报告

**日期**: 2026-01-26
**目标**: 解决 Graph2D 模型类别坍缩问题，提升验证准确率

## 背景

### 问题描述
- 原始 GCN 模型验证准确率 55.8%，但实际发生了**类别坍缩**
- 模型 100% 预测为"机械制图"类别
- 55.8% 准确率仅反映验证集中该类别的比例

### 根本原因
1. **极端类别不平衡**: 92:1 的类别比例
2. **GCN 特征学习失败**: 图特征无法提供足够区分性
3. **损失函数未能阻止坍缩**: 即使使用 Focal Loss

## 实验设计

### 实验配置

| 实验 | 模型 | Hidden | LR | Epochs | Loss | Sampler |
|------|------|--------|-----|--------|------|---------|
| 基线 | GCN | 64 | 1e-3 | 50 | CE | None |
| 实验1 | GCN | 64 | 1e-3 | 50 | Focal(γ=5) | Balanced |
| 实验2 | EdgeSage | 128 | 1e-3 | 50 | Focal(γ=4) | Balanced |
| 实验3 | GCN | 64 | 1e-4 | 100 | Focal(γ=4) | Balanced |
| **实验4** | **EdgeSage** | **256** | **5e-4** | **100** | **Focal(γ=3)** | **Balanced** |

### 关键改进
1. **EdgeGraphSage 架构**: 利用边特征进行消息传递
2. **Balanced Sampler**: 强制每批次包含均衡的类别分布
3. **知识蒸馏**: 使用 HybridClassifier 作为教师模型
4. **数据增强**: 特征抖动增强泛化能力

## 实验结果

### 性能对比

| 实验 | 模型 | 最终 Loss | 最佳 Val Acc | 最终 Val Acc | 状态 |
|------|------|----------|-------------|--------------|------|
| 基线 | GCN | 0.77 | 55.8% | 55.8% | ❌ 类别坍缩 |
| 实验1 | GCN | 0.67 | 4.7% | 0% | ❌ 失败 |
| 实验2 | EdgeSage | 0.40 | 25.6% | 14% | ⚠️ 改善 |
| 实验3 | GCN | 0.95 | 0% | 0% | ❌ 完全失败 |
| **实验4** | **EdgeSage** | **0.35** | **44.2%** | **44.2%** | ✅ **最佳** |

### 训练曲线 (实验4)

```
Epoch   Loss    Val Acc
1       1.31    0.0%
10      0.74    7.0%
20      0.57    2.3%
30      0.48    11.6%
40      0.43    20.9%
50      0.40    20.9%
60      0.41    27.9%
70      0.36    27.9%
80      0.41    32.6%
90      0.36    39.5%
100     0.35    44.2%
```

### 偏置分析

| 模型 | 偏置标准差 | 偏置范围 | 类别坍缩风险 |
|------|-----------|---------|-------------|
| GCN (坍缩) | 0.0801 | 0.2385 | 高 |
| EdgeSage v1 | 0.0576 | 0.1926 | 中 |
| **EdgeSage v2** | **0.0448** | **0.1668** | **低** |

## 关键发现

### 1. EdgeGraphSage 是正确架构
- GCN 所有实验都失败（0-4.7% 准确率）
- EdgeSage 显著优于 GCN（25.6-44.2% 准确率）
- **边特征对 CAD 图分类至关重要**

### 2. 模型容量影响显著
- hidden=128 → 25.6% 准确率
- hidden=256 → 44.2% 准确率
- **提升 73%**

### 3. Balanced Sampler 有效
- 成功打破类别坍缩
- 强制模型学习所有类别
- 验证准确率从伪高（55.8%坍缩）变为真实（44.2%多类别）

### 4. 44.2% 是真实多类别准确率
- 随机猜测准确率仅 3.8%（26类）
- 44.2% 远高于随机水平
- 偏置分布均匀，无坍缩迹象

## 模型文件

| 文件 | 大小 | 配置 | 性能 |
|------|------|------|------|
| `graph2d_edge_sage_v1.pth` | 174KB | hidden=128 | 25.6% |
| `graph2d_edge_sage_v2.pth` | 599KB | hidden=256 | **44.2%** |

## 后续优化方向

1. **增大模型容量**: hidden=512 可能进一步提升
2. **学习率调度**: warmup + cosine decay
3. **增加训练轮数**: 验证准确率仍在上升
4. **更强的数据增强**: 旋转、缩放等几何变换
5. **集成学习**: 多模型投票

## 结论

- **EdgeGraphSage 解决了 GCN 的类别坍缩问题**
- **边特征是 CAD 图分类的关键区分因素**
- **当前最佳模型**: `graph2d_edge_sage_v2.pth` (44.2% 验证准确率)
- **推荐用于生产**: 结合 HybridClassifier 使用

---
*实验环境: Apple M4, MPS 加速, PyTorch 2.10.0*
